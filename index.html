<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Ty Thiết Kế In Ấn Hội An</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Vietnamese IME Library -->
    <script src="https://cdn.jsdelivr.net/npm/vanilla-telex@1/vanilla-telex.min.js"></script>
    <style>
        /* Base styles for the body and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
        }
        #image-input { display: none; }
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .drag-over {
            background-color: #e0f2fe !important; /* light-blue */
            border: 2px dashed #3b82f6; /* blue-500 */
        }
        .dark .drag-over {
            background-color: #1e3a8a !important; /* dark-blue */
        }
        /* Ensure admin view takes full height */
        #admin-view {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .sort-icon {
            margin-left: 8px;
            vertical-align: middle;
        }

        /* Custom styling for modern look - refined for better aesthetics */
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-2xl for softer corners */
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 8px 10px -6px rgba(0, 0, 0, 0.08); /* slightly stronger, diffused shadow */
            padding: 2rem; /* Increased padding for more breathing room */
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out; /* Smooth transitions */
        }
        .dark .card {
            background-color: #1f2937; /* dark:bg-gray-800 */
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2); /* Darker shadow for dark mode */
        }
        .input-field {
            border-radius: 0.75rem; /* rounded-lg, slightly more rounded */
            padding: 0.85rem 1.25rem; /* Increased padding for better touch targets and visual space */
            border: 1px solid #d1d5db; /* border-gray-300 */
            background-color: #f9fafb; /* bg-gray-50 */
            color: #1f2937; /* text-gray-900 */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* Focus ring */
        }
        .dark .input-field {
            background-color: #374151; /* dark:bg-gray-700 */
            border-color: #4b5563; /* dark:border-gray-600 */
            color: #f9fafb; /* dark:text-white */
        }
        .button-primary {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff;
            font-weight: 600; /* font-semibold */
            padding: 0.85rem 1.75rem; /* Increased padding */
            border-radius: 0.75rem; /* rounded-lg */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button-primary:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
            transform: translateY(-1px); /* Slight lift effect */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .button-secondary {
            background-color: #6b7280; /* bg-gray-500 */
            color: #ffffff;
            font-weight: 600; /* font-semibold */
            padding: 0.85rem 1.75rem; /* Increased padding */
            border-radius: 0.75rem; /* rounded-lg */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button-secondary:hover {
            background-color: #4b5563; /* hover:bg-gray-600 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .button-secondary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .table-header {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-normal */
            font-weight: 600; /* Semi-bold headers */
        }
        .dark .table-header {
            background-color: #374151; /* dark:bg-gray-700 */
            color: #d1d5db; /* dark:text-gray-200 */
        }
        .table-row {
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            transition: background-color 0.2s ease-in-out;
        }
        .dark .table-row {
            border-color: #4b5563; /* dark:border-gray-600 */
        }
        .table-row:hover {
            background-color: #f3f4f6; /* hover:bg-gray-100 */
        }
        .dark .table-row:hover {
            background-color: #4b5563; /* dark:hover:bg-gray-600 */
        }
        .table-cell {
            padding: 1rem 1.5rem; /* Increased vertical padding for table cells */
        }
        .action-buttons-group {
            display: flex;
            justify-content: center; /* Center buttons in action column */
            gap: 0.5rem; /* Space between buttons */
        }
    </style>

    <!-- Firebase Configuration -->
    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8",
          authDomain: "data-chung-a62ee.firebaseapp.com",
          databaseURL: "https://data-chung-a62ee-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "data-chung-a62ee",
          storageBucket: "data-chung-a62ee.firebasestorage.app",
          messagingSenderId: "453115303161",
          appId: "1:4531115303161:web:d40a0ec5a38ab7d4863e28",
          measurementId: "G-WNVH78VY1Z"
        };
        // Expose firebaseConfig to the global scope for the main script
        window.__firebase_config = JSON.stringify(firebaseConfig);
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Chat View Container -->
    <div id="chat-view" class="flex h-screen">
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="p-4 border-b dark:border-gray-700 flex items-center justify-between bg-blue-600 text-white">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    <h1 class="text-lg md:text-xl font-bold">(Trợ Lý Ảo) Công Ty Thiết Kế In Ấn Hội An </h1>
                </div>
                 <!-- Admin Button -->
                <button id="admin-button" class="bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg font-semibold text-sm">Quản lý</button>
            </header>

            <div class="chat-container flex-1 p-4 md:p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900"></div>

            <div id="input-area" class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800 rounded-b-lg">
                <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="file" id="image-input" accept="image/*" multiple>
                    <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </label>
                    <input type="text" id="user-input" placeholder="Nhập tin nhắn, dán hoặc kéo thả ảnh..." class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="send-text">Gửi</span>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Admin View Container (Initially Hidden) -->
    <div id="admin-view" class="hidden">
        <header class="p-4 border-b dark:border-gray-700 flex items-center justify-between bg-gray-800 text-white shadow-md">
            <h1 class="text-lg md:text-xl font-bold">Bảng điều khiển Quản lý Giá</h1>
            <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">Đăng xuất</button>
        </header>

        <div id="price-management-content" class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto hidden">
             <!-- Customer Selection -->
            <div class="mb-6 card">
                <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Chọn Khách hàng</h3>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <input type="text" id="customer-select-input" class="input-field flex-1" placeholder="Nhập tên khách hàng hoặc 'mặc định'" value="mặc định">
                    <button type="button" id="load-customer-prices-button" class="button-primary w-full md:w-auto">Tải giá</button>
                </div>
                <p id="current-customer-display" class="mt-4 text-base text-gray-700 dark:text-gray-300">Đang quản lý giá cho: <strong>Mặc định</strong></p>
                <div id="customer-select-error" class="text-red-500 text-sm italic mt-2 hidden"></div>
            </div>

            <!-- Add New Item Form -->
            <div class="mb-6 card">
                <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Thêm/Chỉnh sửa Vật tư</h3>
                <form id="add-edit-price-form" class="flex flex-col md:flex-row md:items-end gap-6">
                    <div class="flex-1">
                        <label for="item-name" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">Tên Vật tư (ví dụ: decal, in bạt):</label>
                        <input type="text" id="item-name" class="input-field w-full" placeholder="Tên vật tư" required>
                    </div>
                    <div class="flex-1">
                        <label for="item-price" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">Giá (VNĐ/m²):</label>
                        <input type="number" id="item-price" class="input-field w-full" placeholder="Giá trên mỗi mét vuông" step="100" required>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 mt-4 md:mt-0 md:justify-end">
                        <button type="submit" id="save-item-button" class="button-primary w-full sm:w-auto">Lưu Vật tư</button>
                        <button type="button" id="cancel-edit-button" class="button-secondary hidden w-full sm:w-auto">Hủy</button>
                    </div>
                </form>
                <div id="price-form-error" class="text-red-500 text-sm italic mt-2 hidden"></div>
            </div>

            <!-- Price List Table -->
            <div class="mb-4">
                <input type="text" id="price-search-input" class="input-field w-full" placeholder="Tìm kiếm vật tư...">
            </div>
            <div class="overflow-x-auto card p-0">
                <table class="min-w-full">
                    <thead>
                        <tr class="table-header">
                            <th class="table-cell text-left cursor-pointer" id="sort-item-name" data-sort-column="name">Tên Vật tư <span class="sort-icon"></span></th>
                            <th class="table-cell text-right cursor-pointer" id="sort-item-price" data-sort-column="price">Giá (VNĐ/m²) <span class="sort-icon"></span></th>
                            <th class="table-cell text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="price-list-body" class="text-gray-600 dark:text-gray-300 text-base font-light">
                        <!-- Prices will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="admin-main-content" class="flex-1 flex items-center justify-center hidden">
            <button id="manage-prices-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg">
                Quản Lý Giá
            </button>
        </div>

    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-96 max-w-full mx-4 sm:mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Đăng nhập Quản trị</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tên đăng nhập:</label>
                    <input type="text" id="admin-username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 dark:bg-gray-700" value="admin">
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Mật khẩu:</label>
                    <input type="password" id="admin-password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 dark:bg-gray-700" value="admin">
                </div>
                <div id="admin-login-error" class="text-red-500 text-xs italic mb-4 hidden"></div>
                <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full sm:w-auto">Đăng nhập</button>
                    <button type="button" id="admin-login-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full sm:w-auto">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm text-center mx-4 sm:mx-auto">
            <p id="custom-message-text" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100"></p>
            <button id="custom-message-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element Selection ---
        // Views
        const chatView = document.getElementById('chat-view');
        const adminView = document.getElementById('admin-view');
        const adminMainContent = document.getElementById('admin-main-content');
        const priceManagementContent = document.getElementById('price-management-content');

        // Chat UI
        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              sendButton = document.getElementById('send-button'), sendText = document.getElementById('send-text'),
              loadingSpinner = document.getElementById('loading-spinner'), imageInput = document.getElementById('image-input'),
              imagePreviewContainer = document.getElementById('image-preview-container'), imageInfo = document.getElementById('image-info'),
              inputArea = document.getElementById('input-area');
        
        // Admin Login
        const adminButton = document.getElementById('admin-button'),
              adminLoginModal = document.getElementById('admin-login-modal'),
              adminLoginForm = document.getElementById('admin-login-form'),
              adminUsernameInput = document.getElementById('admin-username'),
              adminPasswordInput = document.getElementById('admin-password'),
              adminLoginError = document.getElementById('admin-login-error'),
              adminLoginCancelButton = document.getElementById('admin-login-cancel');
        
        // Admin Dashboard
        const logoutButton = document.getElementById('logout-button'),
              managePricesButton = document.getElementById('manage-prices-button'),
              customerSelectInput = document.getElementById('customer-select-input'),
              loadCustomerPricesButton = document.getElementById('load-customer-prices-button'),
              currentCustomerDisplay = document.getElementById('current-customer-display'),
              customerSelectError = document.getElementById('customer-select-error'),
              addEditPriceForm = document.getElementById('add-edit-price-form'),
              itemNameInput = document.getElementById('item-name'),
              itemPriceInput = document.getElementById('item-price'),
              saveItemButton = document.getElementById('save-item-button'),
              cancelEditButton = document.getElementById('cancel-edit-button'),
              priceListBody = document.getElementById('price-list-body'),
              priceFormError = document.getElementById('price-form-error'),
              priceSearchInput = document.getElementById('price-search-input'), 
              sortItemNameHeader = document.getElementById('sort-item-name'), 
              sortItemPriceHeader = document.getElementById('sort-item-price'); 

        // Modals
        const customMessageModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageOkButton = document.getElementById('custom-message-ok');

        // --- State Management ---
        const MAX_IMAGES = 50;
        let chatHistory = [];
        let uploadedImages = [];
        let currentApiKeyIndex = 0;
        let editingItemName = null;

        // Firebase State
        let app, db, auth, userId;
        let isAuthReady = false;
        let allCustomerPrices = {}; 
        let currentManagingCustomerSlug = 'mặc_định';

        // Admin Price List State
        let currentFilterText = '';
        let currentSortColumn = 'name'; // 'name' or 'price'
        let currentSortDirection = 'asc'; // 'asc' or 'desc'

        // ===================================================================================
        // !!! API KEY CONFIGURATION !!!
        // ===================================================================================
        const apiKeys = [
            "AIzaSyCg4gg9GLf6SPzhYCNLmvTZyIuuQZPRw04",
            "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyDxr0SL3tbWE2kdp2oBB3Ru4UxpbuimZD0",
            "AIzaSyBR-duVUWZG-lD5usabYD3NS_-tZySMlcA",
            "AIzaSyBNagv3kn8vAJzbyMYlvLLCccNGbFa4ySc",
        ];

        // --- Helper Functions ---
        const slugify = (text) => text.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim().replace(/\s+/g, '_').replace(/[^\w-]+/g, '').replace(/--+/g, '_');

        // --- AI & Chat Logic ---
        const generateSystemInstruction = () => {
            let priceRules = `\n**Thông tin giá vật tư theo khách hàng:**\n`;
            for (const customerSlug in allCustomerPrices) {
                const customerData = allCustomerPrices[customerSlug];
                priceRules += `- **Giá cho ${customerData.displayName} (tên khách hàng: "${customerData.displayName}"):**\n`;
                for (const itemName in customerData.items) {
                    const price = customerData.items[itemName];
                    const formattedPrice = price.toLocaleString('vi-VN');
                    let userKeyword = itemName.replace(/([A-Z])/g, ' $1').toLowerCase();
                    priceRules += `    - ${userKeyword}: ${formattedPrice} VNĐ/m².\n`;
                }
                priceRules += `\n`;
            }
            const now = new Date();
            const offset = 7 * 60;
            const localTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (offset * 60000));
            const formattedTime = localTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = localTime.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `Bạn là một trợ lý AI đa năng và hữu ích của Công Ty Thiết Kế In Ấn Hội An.
                **Hãy luôn nói chuyện nhẹ nhàng, lịch sự, tôn trọng khách hàng hết mức và thường xuyên sử dụng "dạ vâng" trong các câu trả lời.**
                **Thông tin công ty (chỉ cung cấp khi được hỏi):**
                - **Địa chỉ:** 69 Đào Duy Từ, Hội An.
                - **Zalo / SĐT:** 0935 000 442.
                - **Thời gian hiện tại:** ${formattedTime} ngày ${formattedDate} (GMT+7).
                ${priceRules}
                **Quy tắc tính toán giá:**
                - Khi khách yêu cầu giá, **ưu tiên dùng giá của khách hàng cụ thể nếu tên được nhắc đến**.
                - Nếu có cụm từ "[SỬ DỤNG GIÁ MẶC ĐỊNH]" trong lịch sử chat, **luôn dùng giá "Mặc định"**.
                - Nếu không có tên khách hàng, **luôn dùng giá "Mặc định"**.
                - Công thức: (dài * rộng * số lượng) * giá/m². Mặc định số lượng là 1.
                - Nếu khách nói "có hóa đơn", tính thêm 8% VAT (Tổng giá * 1.08).
                - Luôn làm tròn kết quả và định dạng tiền tệ (ví dụ: 123,456 VNĐ).
                **QUAN TRỌNG:** Sau mỗi câu trả lời, thêm dòng quảng cáo:
                "---<br>Dạ vâng, quý khách có cần thiết kế hay in ấn chuyên nghiệp tại Hội An không ạ? Hãy liên hệ Công Ty Thiết Kế In Ấn Hội An tại 69 Đào Duy Từ, Zalo/SĐT: 0935 000 442 để được tư vấn và hỗ trợ tốt nhất ạ!"`;
        };
        const getGeminiResponse = async (retryCount = 0) => {
            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) throw new Error("Vui lòng cấu hình API key.");
            if (retryCount >= apiKeys.length) throw new Error("Tất cả API key đều không hoạt động.");
            const apiKey = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: chatHistory, systemInstruction: { parts: [{ text: generateSystemInstruction() }] } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(`Lỗi API: ${err.error.message}`); }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts) return result.candidates[0].content.parts[0].text;
                if (result.promptFeedback?.blockReason) return `Yêu cầu bị chặn: ${result.promptFeedback.blockReason}.`;
                throw new Error("Không nhận được phản hồi hợp lệ từ API.");
            } catch (error) {
                console.error(`API key ${currentApiKeyIndex} thất bại:`, error.message);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                return getGeminiResponse(retryCount + 1);
            }
        };
        function getCustomerNameFromInput(text) {
            const colonMatch = text.match(/:(\w+)/);
            if (colonMatch?.[1]) return colonMatch[1];
            const customerPhraseMatch = text.match(/khách hàng\s+([^\s]+)/i);
            if (customerPhraseMatch?.[1]) return customerPhraseMatch[1];
            return null;
        }

        // --- Firestore Price Management ---
        const setupPriceListener = () => {
            if (!db || !isAuthReady) { console.warn("Firestore/Auth chưa sẵn sàng."); return; }
            
            // Get firebaseConfig from the global scope
            const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase config hoặc projectId không hợp lệ.");
                showCustomMessage("Lỗi: Cấu hình Firebase không hợp lệ. Vui lòng kiểm tra console.", 'error');
                return;
            }
            const currentProjectId = firebaseConfig.projectId;
            
            const pricesCollectionRef = collection(db, `artifacts/${currentProjectId}/public/data/customerPrices`);
            onSnapshot(pricesCollectionRef, (snapshot) => {
                const newPrices = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.displayName && data.items) newPrices[doc.id] = data;
                });
                allCustomerPrices = newPrices;
                console.log("Giá đã được cập nhật từ Firestore:", allCustomerPrices);
                renderPriceList(currentManagingCustomerSlug); // Re-render admin list
                
                // Initialize default prices if 'mặc_định' customer doesn't exist or has no items
                if (!allCustomerPrices['mặc_định'] || Object.keys(allCustomerPrices['mặc_định'].items).length === 0) {
                    saveCustomerPrices('mặc định', { displayName: 'Mặc định', items: {} });
                }
            }, (error) => {
                console.error("Lỗi khi tải giá:", error);
                showCustomMessage("Lỗi: Không thể tải giá từ cơ sở dữ liệu. Vui lòng kiểm tra console.", 'error');
            });
        };
        const saveCustomerPrices = async (customerDisplayName, data) => {
            if (!db || !isAuthReady) { showCustomMessage('Hệ thống chưa sẵn sàng.', 'error'); return false; }
            const customerSlug = slugify(customerDisplayName);
            
            // Get firebaseConfig from the global scope
            const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase config hoặc projectId không hợp lệ.");
                showCustomMessage("Lỗi: Cấu hình Firebase không hợp lệ. Vui lòng kiểm tra console.", 'error');
                return false;
            }
            const currentProjectId = firebaseConfig.projectId;

            try {
                const customerDocRef = doc(db, `artifacts/${currentProjectId}/public/data/customerPrices`, customerSlug);
                await setDoc(customerDocRef, data, { merge: true });
                return true;
            } catch (e) {
                console.error("Lỗi khi lưu giá:", e);
                showCustomMessage(`Lỗi khi lưu giá: ${e.message}`, 'error');
                return false;
            }
        };
        const deleteItemPriceForCurrentCustomer = async (itemName) => {
            if (!db || !isAuthReady) { showCustomMessage('Hệ thống chưa sẵn sàng.', 'error'); return; }
            const customerSlug = currentManagingCustomerSlug;
            const customerData = allCustomerPrices[customerSlug];
            if (!customerData) return;
            
            // Create a copy of items to modify
            const updatedItems = { ...customerData.items };
            delete updatedItems[itemName];

            const success = await saveCustomerPrices(customerData.displayName, { ...customerData, items: updatedItems });
            if (success) {
                showCustomMessage(`Đã xóa vật tư "${itemName}".`, 'success');
            }
        };

        // --- View Control Functions ---
        function showChatView() {
            chatView.style.display = 'flex'; // Explicitly show chat
            adminView.style.display = 'none'; // Explicitly hide admin
            adminLoginModal.classList.add('hidden'); // Ensure modal is hidden
            priceManagementContent.classList.add('hidden'); // Ensure price management is hidden
            adminMainContent.classList.add('hidden'); // Ensure main admin content is hidden
            console.log("Showing Chat View.");
        }

        function showAdminLogin() {
            chatView.style.display = 'none'; // Explicitly hide chat
            adminView.style.display = 'flex'; // Explicitly show admin container
            adminLoginModal.classList.remove('hidden'); // Show the login modal
            priceManagementContent.classList.add('hidden');
            priceManagementContent.style.display = 'none'; // Ensure hidden
            adminMainContent.classList.add('hidden');
            adminMainContent.style.display = 'none'; // Ensure hidden
            console.log("Showing Admin Login Modal.");
        }

        function showPriceManagementDashboard() {
            console.log("Attempting to show Price Management Dashboard...");
            chatView.style.display = 'none'; // Explicitly hide chat
            adminView.style.display = 'flex'; // Explicitly show admin container
            adminLoginModal.classList.add('hidden'); // Hide login modal
            priceManagementContent.classList.remove('hidden');
            priceManagementContent.style.display = 'flex'; // Explicitly show price management content as flex
            adminMainContent.classList.add('hidden');
            adminMainContent.style.display = 'none'; // Explicitly hide admin main content
            
            console.log("priceManagementContent hidden class:", priceManagementContent.classList.contains('hidden'));
            console.log("priceManagementContent display style:", priceManagementContent.style.display);
            console.log("adminMainContent hidden class:", adminMainContent.classList.contains('hidden'));
            console.log("adminMainContent display style:", adminMainContent.style.display);

            currentFilterText = '';
            priceSearchInput.value = '';
            currentSortColumn = 'name';
            currentSortDirection = 'asc';
            updateSortIcons();
            renderPriceList(currentManagingCustomerSlug);
            console.log("Price Management Dashboard display logic executed.");
        }

        // --- UI & Event Handlers ---
        // Chat form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message && uploadedImages.length === 0) return;

            appendMessage({ text: message, images: uploadedImages.map(img => img.file) }, 'user');
            const imagesForHistory = [...uploadedImages];
            userInput.value = '';
            imagePreviewContainer.innerHTML = '';
            uploadedImages = [];
            updateImageCount();

            const potentialCustomerName = getCustomerNameFromInput(message);
            const customerSlug = potentialCustomerName ? slugify(potentialCustomerName) : null;
            if (potentialCustomerName && !allCustomerPrices[customerSlug]) {
                showCustomConfirm(`Khách hàng "${potentialCustomerName}" không tồn tại. Bạn có muốn tính theo giá mặc định không?`, () => processMessage(message, imagesForHistory, true));
                return;
            }
            processMessage(message, imagesForHistory, false);
        });

        async function processMessage(message, images, useDefaultPrice) {
            toggleLoading(true);
            try {
                const userParts = [];
                if (message) userParts.push({ text: message });
                images.forEach(img => userParts.push({ inlineData: { mimeType: img.mimeType, data: img.data } }));
                if (useDefaultPrice) userParts.push({ text: "[SỬ DỤNG GIÁ MẶC ĐỊNH]" });
                
                chatHistory.push({ role: "user", parts: userParts });
                const botResponse = await getGeminiResponse();
                appendMessage({ text: botResponse }, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
            } catch (error) {
                appendMessage({ text: error.message }, 'bot', true);
            } finally {
                toggleLoading(false);
            }
        }
        
        // Admin Login Flow
        adminButton.addEventListener('click', showAdminLogin);
        adminLoginCancelButton.addEventListener('click', showChatView);
        
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (adminUsernameInput.value === 'admin' && adminPasswordInput.value === 'admin') {
                showPriceManagementDashboard(); // Directly show the price management
            } else {
                adminLoginError.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng.';
                adminLoginError.classList.remove('hidden');
            }
        });

        // Admin Dashboard Flow
        logoutButton.addEventListener('click', showChatView);
        managePricesButton.addEventListener('click', showPriceManagementDashboard); // Button to navigate to price management from main admin area

        loadCustomerPricesButton.addEventListener('click', () => {
            const customerName = customerSelectInput.value.trim();
            if (!customerName) {
                customerSelectError.textContent = 'Vui lòng nhập tên khách hàng.';
                customerSelectError.classList.remove('hidden');
                return;
            }
            currentManagingCustomerSlug = slugify(customerName);
            currentCustomerDisplay.innerHTML = `Đang quản lý giá cho: <strong>${customerName}</strong>`;
            customerSelectError.classList.add('hidden');
            renderPriceList(currentManagingCustomerSlug);
            resetAddEditForm();
        });

        priceSearchInput.addEventListener('input', (e) => {
            currentFilterText = e.target.value.toLowerCase();
            renderPriceList(currentManagingCustomerSlug);
        });

        sortItemNameHeader.addEventListener('click', () => {
            if (currentSortColumn === 'name') {
                currentSortDirection = (currentSortDirection === 'asc' ? 'desc' : 'asc');
            } else {
                currentSortColumn = 'name';
                currentSortDirection = 'asc';
            }
            updateSortIcons();
            renderPriceList(currentManagingCustomerSlug);
        });

        sortItemPriceHeader.addEventListener('click', () => {
            if (currentSortColumn === 'price') {
                currentSortDirection = (currentSortDirection === 'asc' ? 'desc' : 'asc');
            } else {
                currentSortColumn = 'price';
                currentSortDirection = 'asc';
            }
            updateSortIcons();
            renderPriceList(currentManagingCustomerSlug);
        });

        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = ''); // Clear all
            let iconElement;
            if (currentSortColumn === 'name') {
                iconElement = sortItemNameHeader.querySelector('.sort-icon');
            } else if (currentSortColumn === 'price') {
                iconElement = sortItemPriceHeader.querySelector('.sort-icon');
            }
            if (iconElement) {
                iconElement.textContent = currentSortDirection === 'asc' ? '▲' : '▼';
            }
        }

        addEditPriceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemName = itemNameInput.value.trim();
            const itemPrice = parseFloat(itemPriceInput.value);
            if (!itemName || isNaN(itemPrice) || itemPrice <= 0) {
                priceFormError.textContent = 'Vui lòng nhập tên và giá hợp lệ.';
                priceFormError.classList.remove('hidden');
                return;
            }
            const camelCaseItemName = itemName.replace(/(?:^\w|[A-Z]|\b\w)/g, (w, i) => i === 0 ? w.toLowerCase() : w.toUpperCase()).replace(/\s+/g, '');
            const customerSlug = currentManagingCustomerSlug;
            const customerDisplayName = allCustomerPrices[customerSlug]?.displayName || customerSelectInput.value.trim();
            const customerData = allCustomerPrices[customerSlug] || { displayName: customerDisplayName, items: {} };
            
            if (!editingItemName && customerData.items.hasOwnProperty(camelCaseItemName)) {
                priceFormError.textContent = `Vật tư "${itemName}" đã tồn tại.`;
                priceFormError.classList.remove('hidden');
                return;
            }
            
            customerData.items[camelCaseItemName] = itemPrice;
            const success = await saveCustomerPrices(customerDisplayName, customerData);
            if (success) {
                resetAddEditForm();
                showCustomMessage(`Đã lưu vật tư "${itemName}".`, 'success');
                renderPriceList(currentManagingCustomerSlug); // Re-render to show updated list
            }
        });
        cancelEditButton.addEventListener('click', resetAddEditForm);
        function resetAddEditForm() {
            addEditPriceForm.reset();
            itemNameInput.readOnly = false;
            saveItemButton.textContent = 'Lưu Vật tư';
            cancelEditButton.classList.add('hidden');
            editingItemName = null;
            priceFormError.classList.add('hidden');
        }

        const renderPriceList = (customerSlug) => {
            priceListBody.innerHTML = '';
            const customerData = allCustomerPrices[customerSlug];
            
            if (!customerData || Object.keys(customerData.items).length === 0) {
                priceListBody.innerHTML = `<tr><td colspan="3" class="table-cell text-center text-gray-500 py-4">Chưa có vật tư nào.</td></tr>`;
                return;
            }

            let itemsArray = Object.entries(customerData.items).map(([name, price]) => ({ name, price }));

            // Filter
            if (currentFilterText) {
                itemsArray = itemsArray.filter(item => 
                    item.name.toLowerCase().includes(currentFilterText) || 
                    item.price.toString().includes(currentFilterText)
                );
            }

            // Sort
            itemsArray.sort((a, b) => {
                let valA, valB;
                if (currentSortColumn === 'name') {
                    valA = a.name.toLowerCase();
                    valB = b.name.toLowerCase();
                } else { // 'price'
                    valA = a.price;
                    valB = b.price;
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            if (itemsArray.length === 0) {
                 priceListBody.innerHTML = `<tr><td colspan="3" class="table-cell text-center text-gray-500 py-4">Không tìm thấy vật tư nào phù hợp với tìm kiếm.</td></tr>`;
                 return;
            }

            itemsArray.forEach(({ name, price }) => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `<td class="table-cell text-left">${name}</td>
                                 <td class="table-cell text-right">${price.toLocaleString('vi-VN')}</td>
                                 <td class="table-cell text-center action-buttons-group">
                                     <button class="edit-item-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-xs" data-item-name="${name}">Sửa</button>
                                     <button class="delete-item-button bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-xs" data-item-name="${name}">Xóa</button>
                                 </td>`;
                priceListBody.appendChild(row);
            });

            document.querySelectorAll('.edit-item-button').forEach(b => b.addEventListener('click', (e) => {
                const name = e.target.dataset.itemName;
                editingItemName = name;
                itemNameInput.value = name;
                itemPriceInput.value = allCustomerPrices[customerSlug].items[name];
                itemNameInput.readOnly = true;
                saveItemButton.textContent = 'Cập nhật';
                cancelEditButton.classList.remove('hidden');
            }));
            document.querySelectorAll('.delete-item-button').forEach(b => b.addEventListener('click', (e) => {
                const name = e.target.dataset.itemName;
                showCustomConfirm(`Bạn có chắc chắn muốn xóa "${name}"?`, () => deleteItemPriceForCurrentCustomer(name));
            }));
        };

        // Modal Handlers
        function showCustomMessage(message, type = 'info') { customMessageText.textContent = message; customMessageModal.classList.remove('hidden'); }
        customMessageOkButton.addEventListener('click', () => customMessageModal.classList.add('hidden'));
        function showCustomConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]';
            modal.innerHTML = `<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm text-center mx-4 sm:mx-auto">
                <p class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">${message}</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Có</button>
                    <button id="confirm-no" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Không</button>
                </div></div>`;
            document.body.appendChild(modal);
            document.getElementById('confirm-yes').addEventListener('click', () => { onConfirm(); modal.remove(); });
            document.getElementById('confirm-no').addEventListener('click', () => modal.remove());
        }

        // Image Handling Helpers
        function processFiles(files) { if (!files || files.length === 0) return; if (uploadedImages.length + files.length > MAX_IMAGES) { showCustomMessage(`Chỉ có thể tải lên tối đa ${MAX_IMAGES} ảnh.`); return; } for (const file of Array.from(files).filter(f => f.type.startsWith('image/'))) { if (uploadedImages.some(img => img.file.name === file.name && img.file.size === file.size)) continue; const reader = new FileReader(); reader.onload = (e) => { const base64Data = e.target.result.split(',')[1]; uploadedImages.push({ data: base64Data, mimeType: file.type, file: file }); createImagePreview(e.target.result, file); updateImageCount(); }; reader.readAsDataURL(file); } }
        imageInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        userInput.addEventListener('paste', (e) => { processFiles(e.clipboardData?.files); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.remove('drag-over')));
        inputArea.addEventListener('drop', (e) => { processFiles(e.dataTransfer?.files); });
        function createImagePreview(dataUrl, file) { const pWrap = document.createElement('div'); pWrap.className = 'relative'; const img = document.createElement('img'); img.src = dataUrl; img.className = 'h-16 w-16 object-cover rounded-md'; pWrap.appendChild(img); const rBtn = document.createElement('button'); rBtn.innerHTML = '&times;'; rBtn.className = 'absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs'; rBtn.onclick = () => { uploadedImages = uploadedImages.filter(img => img.file !== file); pWrap.remove(); updateImageCount(); }; pWrap.appendChild(rBtn); imagePreviewContainer.appendChild(pWrap); }
        function updateImageCount() { imageInfo.textContent = uploadedImages.length > 0 ? `Đã tải lên ${uploadedImages.length}/${MAX_IMAGES} ảnh.` : ''; }
        function appendMessage(data, sender, isError = false) { const { text, images } = data; const msgWrap = document.createElement('div'); msgWrap.className = `flex items-start gap-3 mb-4 ${sender === 'user' ? 'justify-end' : ''}`; const msgContent = document.createElement('div'); msgContent.className = `p-3 rounded-lg max-w-xs md:max-w-md lg:max-w-xl ${sender === 'user' ? 'bg-blue-600 text-white' : isError ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 'bg-gray-200 dark:bg-gray-700'}`; if (images?.length) { const grid = document.createElement('div'); grid.className = 'grid grid-cols-3 gap-1'; images.forEach(file => { const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = 'w-full h-auto object-cover rounded'; img.onload = () => URL.revokeObjectURL(img.src); grid.appendChild(img); }); msgContent.appendChild(grid); } if (text) { const p = document.createElement('p'); p.className = `text-sm ${images?.length ? 'mt-2' : ''}`; p.innerHTML = text.replace(/\n/g, '<br>'); msgContent.appendChild(p); } const avatar = document.createElement('div'); avatar.className = `flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center font-bold text-white ${sender === 'user' ? 'bg-gray-500' : isError ? 'bg-red-500' : 'bg-blue-500'}`; avatar.textContent = sender === 'user' ? 'U' : 'B'; if (sender === 'user') { msgWrap.append(msgContent, avatar); } else { msgWrap.append(avatar, msgContent); } document.querySelector('.chat-container').appendChild(msgWrap); document.querySelector('.chat-container').scrollTop = document.querySelector('.chat-container').scrollHeight; }
        function toggleLoading(isLoading) { sendButton.disabled = isLoading; userInput.disabled = isLoading; document.getElementById('image-upload-button').style.pointerEvents = isLoading ? 'none' : 'auto'; sendText.classList.toggle('hidden', isLoading); loadingSpinner.classList.toggle('hidden', !isLoading); if (!isLoading) userInput.focus(); }

        // --- App Initialization ---
        const main = async () => {
            appendMessage({ text: "Xin chào! Tôi là trợ lý ảo. Tôi có thể giúp gì cho bạn?" }, 'bot');
            try {
                // Get firebaseConfig from the global scope
                const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
                
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                    throw new Error("Cấu hình Firebase không đầy đủ hoặc không hợp lệ.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    userId = user?.uid;
                    isAuthReady = !!user;
                    if (isAuthReady) {
                        console.log("Firebase Auth sẵn sàng. User ID:", userId);
                        setupPriceListener(); // Load prices once authenticated
                    }
                });

                // Attempt to sign in with custom token, with fallback to anonymous
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Signed in with custom token.");
                    } catch (tokenError) {
                        console.warn("Custom token sign-in failed, attempting anonymous sign-in:", tokenError);
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously as fallback.");
                    }
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (no custom token provided).");
                }
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                appendMessage({ text: `Lỗi: Không thể kết nối đến dịch vụ Firebase. Vui lòng kiểm tra console để biết chi tiết. (${error.message})` }, 'bot', true);
            }

            // Set initial view state after Firebase initialization
            showChatView();
        };

        // Start the application
        main();
    </script>
</body>
</html>
