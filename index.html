<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Ty Thiết Kế In Ấn Hội An</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Vietnamese IME Library -->
    <script src="https://cdn.jsdelivr.net/npm/vanilla-telex@1/vanilla-telex.min.js"></script>
    <style>
        /* Base styles for the body and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .dark body {
            background-color: #111827;
        }
        #image-input { display: none; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .chat-container::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark .chat-container::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .drag-over {
            background-color: #e0f2fe !important; /* light-blue */
            border: 2px dashed #3b82f6; /* blue-500 */
        }
        .dark .drag-over {
            background-color: #1e3a8a !important; /* dark-blue */
        }
        /* Styles for camera feed */
        #camera-feed {
            width: 100%;
            max-width: 320px; /* Limit camera feed width for better mobile experience */
            height: auto;
            border-radius: 0.75rem; /* rounded-lg */
            margin-bottom: 0.5rem;
            background-color: #000;
            display: none; /* Hidden by default */
        }
        #camera-canvas {
            display: none; /* Hidden, used for capturing frames */
        }
        .camera-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .camera-button {
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .camera-button:hover {
            background-color: #059669; /* green-600 */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .camera-button:disabled {
            background-color: #6ee7b7; /* green-200 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* New UI Styles for Chat Bubbles */
        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .message-fade-in {
            animation: message-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .avatar-container {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .avatar-container svg {
            width: 24px;
            height: 24px;
        }
    </style>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8",
          authDomain: "data-chung-a62ee.firebaseapp.com",
          databaseURL: "https://data-chung-a62ee-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "data-chung-a62ee",
          storageBucket: "data-chung-a62ee.firebasestorage.app",
          messagingSenderId: "453115303161",
          appId: "1:4531115303161:web:d40a0ec5a38ab7d4863e28",
          measurementId: "G-WNVH78VY1Z"
        };
        window.__firebase_config = JSON.stringify(firebaseConfig);
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Chat View Container -->
    <div id="chat-view" class="flex h-screen">
        <main class="flex-1 flex flex-col bg-white dark:bg-gray-800">
            <!-- Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    </div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white">Trợ lý In ấn Hội An</h1>
                </div>
            </header>

            <div class="chat-container flex-1 p-4 md:p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800"></div>

            <div id="input-area" class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                <!-- Camera Feed and Controls -->
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-controls">
                    <button id="start-camera-button" class="camera-button">Bật Camera</button>
                    <button id="capture-send-button" class="camera-button" disabled>Chụp Ảnh</button>
                    <button id="switch-camera-button" class="camera-button hidden" disabled>Chuyển Camera</button>
                </div>

                <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="file" id="image-input" accept="image/*" multiple>
                    <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </label>
                    <input type="text" id="user-input" placeholder="Nhập tin nhắn..." class="flex-1 p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-all" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-blue-600 text-white w-12 h-12 rounded-full font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0 transition-transform hover:scale-110 active:scale-100">
                        <span id="send-text" class="hidden">Gửi</span>
                        <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Custom Message Modal (Kept for general messages) -->
    <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm text-center mx-4 sm:mx-auto">
            <p id="custom-message-text" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100"></p>
            <button id="custom-message-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- DOM Element Selection ---
        const chatView = document.getElementById('chat-view');
        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              sendButton = document.getElementById('send-button'), sendText = document.getElementById('send-text'),
              sendIcon = document.getElementById('send-icon'),
              loadingSpinner = document.getElementById('loading-spinner'), imageInput = document.getElementById('image-input'),
              imagePreviewContainer = document.getElementById('image-preview-container'), imageInfo = document.getElementById('image-info'),
              inputArea = document.getElementById('input-area');
        
        // Camera elements
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const cameraControls = document.querySelector('.camera-controls');
        const startCameraButton = document.getElementById('start-camera-button');
        const captureSendButton = document.getElementById('capture-send-button');
        const switchCameraButton = document.getElementById('switch-camera-button'); 
        let mediaStream = null; 
        let availableVideoDevices = []; 
        let currentCameraIndex = -1; 

        // Modals
        const customMessageModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageOkButton = document.getElementById('custom-message-ok');

        // --- State Management ---
        const MAX_IMAGES = 100; 
        let chatHistory = [];
        let uploadedImages = []; // Single source of truth for all images (uploaded or captured)
        let currentApiKeyIndex = 0;

        // Firebase State (simplified)
        let app, db, auth, userId;
        let isAuthReady = false;

        // ===================================================================================
        // !!! API KEY CONFIGURATION !!!
        // ===================================================================================
        const apiKeys = [
            "AIzaSyCg4gg9GLf6SPzhYCNLmvTZyIuuQZPRw04",
            "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyDxr0SL3tbWE2kdp2oBB3Ru4UxpbuimZD0",
            "AIzaSyBR-duVUWZG-lD5usabYD3NS_-tZySMlcA",
            "AIzaSyBNagv3kn8vAJzbyMYlvLLCccNGbFa4ySc",
        ];

        // --- Helper Functions ---
        const isMobileDevice = () => {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        };

        // --- AI & Chat Logic ---
        const generateSystemInstruction = () => {
            const now = new Date();
            const offset = 7 * 60;
            const localTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (offset * 60000));
            const formattedTime = localTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = localTime.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `Bạn là trợ lý ảo của Công Ty Thiết Kế In Ấn Hội An.
                    **Hãy luôn trả lời "dạ thưa", đưa ra phản hồi nhanh chóng và đảm bảo kết quả chính xác 100%.**
                    **Thông tin công ty (chỉ cung cấp khi được hỏi):**
                    - **Địa chỉ:** 69 Đào Duy Từ, Hội An.
                    - **Zalo / SĐT:** 0935 000 442.
                    - **Thời gian hiện tại:** ${formattedTime} ngày ${formattedDate} (GMT+7).
                    
                    **Quy tắc tính toán giá (giá cố định, không có dữ liệu giá động từ admin):**
                    - Giá decal: 85,000 VNĐ/m²
                    - Giá in bạt: 70,000 VNĐ/m²
                    - Giá standee: 120,000 VNĐ/m²
                    - Công thức: (dài * rộng * số lượng) * giá/m². Mặc định số lượng là 1.
                    - Nếu khách nói "có hóa đơn", tính thêm 8% VAT (Tổng giá * 1.08).
                    - Luôn làm tròn kết quả và định dạng tiền tệ (ví dụ: 123,456 VNĐ).
                    **QUAN TRỌNG:** Sau mỗi câu trả lời, thêm dòng quảng cáo:
                    "---<br>Dạ vâng, quý khách có cần thiết kế hay in ấn chuyên nghiệp tại Hội An không ạ? Hãy liên hệ Công Ty Thiết Kế In Ấn Hội An tại 69 Đào Duy Từ, Zalo/SĐT: 0935 000 442 để được tư vấn và hỗ trợ tốt nhất ạ!"`;
        };

        const getGeminiResponse = async (retryCount = 0) => {
            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) throw new Error("Vui lòng cấu hình API key.");
            if (retryCount >= apiKeys.length) throw new Error("Tất cả API key đều không hoạt động.");
            const apiKey = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = { contents: chatHistory, systemInstruction: { parts: [{ text: generateSystemInstruction() }] } };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(`Lỗi API: ${err.error.message}`); }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts) return result.candidates[0].content.parts[0].text;
                if (result.promptFeedback?.blockReason) return `Yêu cầu bị chặn: ${result.promptFeedback.blockReason}.`;
                throw new Error("Không nhận được phản hồi hợp lệ từ API.");
            } catch (error) {
                console.error(`API key ${currentApiKeyIndex} thất bại:`, error.message);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                return getGeminiResponse(retryCount + 1);
            }
        };

        // --- View Control Functions (Simplified for chat only) ---
        function showChatView() {
            chatView.style.display = 'flex'; 
            console.log("Showing Chat View.");
        }

        // --- Camera Functions ---
        async function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraFeed.style.display = 'none';
                startCameraButton.textContent = 'Bật Camera';
                captureSendButton.disabled = true;
                captureSendButton.textContent = 'Chụp Ảnh';
                switchCameraButton.classList.add('hidden'); 
                switchCameraButton.disabled = true;
                mediaStream = null;
                availableVideoDevices = []; 
                currentCameraIndex = -1; 
                showCustomMessage('Camera đã tắt.', 'info');
            }
        }

        async function startCamera(deviceId = null) {
            if (mediaStream) { 
                mediaStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }
                }
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            } else {
                constraints.video.facingMode = { exact: 'environment' }; // Prefer rear camera
            }

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = mediaStream;
                cameraFeed.style.display = 'block';
                startCameraButton.textContent = 'Tắt Camera';
                captureSendButton.disabled = false;
                captureSendButton.textContent = 'Chụp Ảnh';
                
                await enumerateCameras();
                if (availableVideoDevices.length > 1) {
                    switchCameraButton.classList.remove('hidden');
                    switchCameraButton.disabled = false;
                } else {
                    switchCameraButton.classList.add('hidden');
                    switchCameraButton.disabled = true;
                }

                showCustomMessage('Camera đã bật.', 'info');
            } catch (err) {
                console.error('Lỗi khi truy cập camera:', err);
                if (!deviceId && constraints.video.facingMode && err.name === 'OverconstrainedError') {
                    try {
                        constraints.video.facingMode = { exact: 'user' }; // Try front camera
                        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                        cameraFeed.srcObject = mediaStream;
                        cameraFeed.style.display = 'block';
                        startCameraButton.textContent = 'Tắt Camera';
                        captureSendButton.disabled = false;
                        captureSendButton.textContent = 'Chụp Ảnh';
                        await enumerateCameras(); 
                        if (availableVideoDevices.length > 1) {
                            switchCameraButton.classList.remove('hidden');
                            switchCameraButton.disabled = false;
                        } else {
                            switchCameraButton.classList.add('hidden');
                            switchCameraButton.disabled = true;
                        }
                        showCustomMessage('Camera đã bật (camera trước).', 'info');
                    } catch (userErr) {
                        console.error('Lỗi khi truy cập camera trước:', userErr);
                        showCustomMessage(`Không thể truy cập camera: ${userErr.message}. Vui lòng kiểm tra quyền truy cập.`, 'error');
                        stopCamera(); 
                    }
                } else {
                    showCustomMessage(`Không thể truy cập camera: ${err.message}. Vui lòng kiểm tra quyền truy cập.`, 'error');
                    stopCamera(); 
                }
            }
        }

        async function enumerateCameras() {
            availableVideoDevices = [];
            currentCameraIndex = -1; 
            const devices = await navigator.mediaDevices.enumerateDevices();
            let foundCurrentCamera = false;

            devices.forEach((device) => {
                if (device.kind === 'videoinput') {
                    availableVideoDevices.push(device);
                }
            });

            if (mediaStream && mediaStream.getVideoTracks().length > 0) {
                const activeTrack = mediaStream.getVideoTracks()[0];
                const activeDeviceId = activeTrack.getSettings().deviceId;
                const activeLabel = activeTrack.label;

                let foundIndex = availableVideoDevices.findIndex(dev => dev.deviceId === activeDeviceId);
                if (foundIndex === -1) {
                    foundIndex = availableVideoDevices.findIndex(dev => dev.label === activeLabel);
                }

                if (foundIndex !== -1) {
                    currentCameraIndex = foundIndex;
                    foundCurrentCamera = true;
                }
            }

            if (!foundCurrentCamera && availableVideoDevices.length > 0) {
                currentCameraIndex = 0;
            }
        }

        startCameraButton.addEventListener('click', async () => {
            if (mediaStream && mediaStream.active) {
                stopCamera();
            } else {
                await startCamera(); 
            }
        });

        switchCameraButton.addEventListener('click', async () => {
            if (availableVideoDevices.length > 1) {
                currentCameraIndex = (currentCameraIndex + 1) % availableVideoDevices.length;
                const nextDeviceId = availableVideoDevices[currentCameraIndex].deviceId;
                await startCamera(nextDeviceId);
            } else {
                showCustomMessage('Chỉ có một camera khả dụng.', 'info');
            }
        });

        captureSendButton.addEventListener('click', () => {
            if (mediaStream && mediaStream.active) {
                if (uploadedImages.length >= MAX_IMAGES) {
                    showCustomMessage(`Bạn đã đạt đến giới hạn tối đa ${MAX_IMAGES} ảnh.`);
                    return;
                }

                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraFeed.videoWidth;
                cameraCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                
                const filename = `captured_${Date.now()}.jpeg`;
                const capturedFile = dataURLtoFile(cameraCanvas.toDataURL('image/jpeg', 0.8), filename);
                
                uploadedImages.push(capturedFile);
                createImagePreview(URL.createObjectURL(capturedFile), capturedFile);
                updateImageCount();
                showCustomMessage('Đã chụp ảnh. Bạn có thể chụp thêm hoặc gửi đi.', 'info');

            } else {
                showCustomMessage('Vui lòng bật camera trước khi chụp ảnh.', 'warning');
            }
        });

        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        // --- UI & Event Handlers ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            const imagesToSubmit = [...uploadedImages]; 
            
            if (!message && imagesToSubmit.length === 0) {
                showCustomMessage("Vui lòng nhập tin nhắn hoặc tải lên ảnh.", "warning");
                return;
            }

            appendMessage({ text: message, images: imagesToSubmit }, 'user');
            
            userInput.value = '';
            imagePreviewContainer.innerHTML = '';
            uploadedImages = [];
            updateImageCount();

            toggleLoading(true);

            const userPartsForAPI = [];
            if (message) userPartsForAPI.push({ text: message });

            const imageConversionPromises = imagesToSubmit.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        userPartsForAPI.push({
                            inlineData: {
                                mimeType: file.type,
                                data: e.target.result.split(',')[1]
                            }
                        });
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });

            try {
                await Promise.all(imageConversionPromises); 
                chatHistory.push({ role: "user", parts: userPartsForAPI });
                const botResponse = await getGeminiResponse();
                appendMessage({ text: botResponse }, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
            } catch (error) {
                appendMessage({ text: `Lỗi: ${error.message}` }, 'bot', true);
            } finally {
                toggleLoading(false);
            }
        });
        
        function showCustomMessage(message, type = 'info') { customMessageText.textContent = message; customMessageModal.classList.remove('hidden'); }
        customMessageOkButton.addEventListener('click', () => customMessageModal.classList.add('hidden'));

        function processFiles(files) { 
            if (!files || files.length === 0) return; 
            const newImageCount = uploadedImages.length + files.length;
            if (newImageCount > MAX_IMAGES) { 
                showCustomMessage(`Chỉ có thể tải lên tối đa ${MAX_IMAGES} ảnh. Bạn đã chọn ${newImageCount} ảnh.`); 
                return; 
            } 
            for (const file of Array.from(files).filter(f => f.type.startsWith('image/'))) { 
                if (uploadedImages.some(img => img.name === file.name && img.size === file.size)) continue; 
                uploadedImages.push(file); 
                createImagePreview(URL.createObjectURL(file), file); 
            } 
            updateImageCount(); 
        }
        imageInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        userInput.addEventListener('paste', (e) => { processFiles(e.clipboardData?.files); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.remove('drag-over')));
        inputArea.addEventListener('drop', (e) => { processFiles(e.dataTransfer?.files); });
        
        function createImagePreview(dataUrl, file) { 
            const pWrap = document.createElement('div'); 
            pWrap.className = 'relative'; 
            const img = document.createElement('img'); 
            img.src = dataUrl; 
            img.className = 'h-16 w-16 object-cover rounded-md shadow-md'; 
            pWrap.appendChild(img); 
            const rBtn = document.createElement('button'); 
            rBtn.innerHTML = '&times;'; 
            rBtn.className = 'absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs shadow-lg'; 
            rBtn.onclick = () => { 
                uploadedImages = uploadedImages.filter(item => item !== file); 
                pWrap.remove(); 
                updateImageCount(); 
            }; 
            pWrap.appendChild(rBtn); 
            imagePreviewContainer.appendChild(pWrap); 
        }
        function updateImageCount() { 
            const totalImages = uploadedImages.length;
            imageInfo.textContent = totalImages > 0 ? `Đã chọn ${totalImages}/${MAX_IMAGES} ảnh.` : ''; 
        }
        
        function appendMessage(data, sender, isError = false) { 
            const { text, images } = data; 
            const msgWrap = document.createElement('div'); 
            msgWrap.className = `flex items-start gap-3 mb-6 message-fade-in ${sender === 'user' ? 'justify-end' : ''}`; 
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar-container';
            
            const msgContent = document.createElement('div'); 
            msgContent.className = `p-4 rounded-2xl shadow-md max-w-xs md:max-w-md lg:max-w-xl`; 

            if (sender === 'user') {
                avatar.classList.add('bg-gray-300', 'dark:bg-gray-600');
                avatar.innerHTML = `<svg class="text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                msgContent.classList.add('bg-blue-500', 'text-white', 'rounded-br-lg');
            } else {
                avatar.classList.add(isError ? 'bg-red-500' : 'bg-blue-500');
                avatar.innerHTML = isError 
                    ? `<svg class="text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`
                    : `<svg class="text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 4c-2.23 0-4.14 1.25-5.1 3.05A8.93 8.93 0 0 0 4 9c-2.21 0-4 1.79-4 4s1.79 4 4 4h1v2h-1c-3.31 0-6-2.69-6-6 0-2.95 2.14-5.43 5-5.92V4h1c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h1v2h-1c1.55 0 2.96.59 4 1.54V4h1c1.1 0 2 .9 2 2v1c.73.55 1.39 1.22 1.92 2H23v-1c0-2.21-1.79-4-4-4h-4zm-2 5h-2v2H9v2h2v2h2v-2h2v-2h-2V9z"/></svg>`;
                
                if (isError) {
                    msgContent.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-800', 'dark:text-red-200', 'rounded-bl-lg');
                } else {
                    msgContent.classList.add('bg-gray-100', 'dark:bg-gray-700', 'rounded-bl-lg');
                }
            }
            
            if (images?.length) { 
                const grid = document.createElement('div'); 
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2 rounded-lg overflow-hidden'; 
                images.forEach(imgData => { 
                    const img = document.createElement('img'); 
                    img.src = URL.createObjectURL(imgData);
                    img.className = 'w-full h-auto object-cover rounded-md aspect-square'; 
                    img.onload = () => URL.revokeObjectURL(img.src); 
                    grid.appendChild(img); 
                }); 
                msgContent.appendChild(grid); 
            } 
            
            if (text) { 
                const p = document.createElement('p'); 
                p.className = `text-sm leading-relaxed ${images?.length ? 'mt-3' : ''}`; 
                p.innerHTML = text.replace(/\n/g, '<br>'); 
                msgContent.appendChild(p); 
            } 
            
            if (sender === 'user') { 
                msgWrap.append(msgContent, avatar); 
            } else { 
                msgWrap.append(avatar, msgContent); 
            } 
            document.querySelector('.chat-container').appendChild(msgWrap); 
            document.querySelector('.chat-container').scrollTop = document.querySelector('.chat-container').scrollHeight; 
        }

        function toggleLoading(isLoading) { 
            sendButton.disabled = isLoading; 
            userInput.disabled = isLoading; 
            document.getElementById('image-upload-button').style.pointerEvents = isLoading ? 'none' : 'auto'; 
            
            sendIcon.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading); 

            if (isMobileDevice()) {
                startCameraButton.disabled = isLoading; 
                captureSendButton.disabled = isLoading || !mediaStream || !mediaStream.active; 
                switchCameraButton.disabled = isLoading || availableVideoDevices.length <= 1; 
            }

            if (!isLoading) userInput.focus(); 
        }

        // --- App Initialization ---
        const main = async () => {
            if (!isMobileDevice()) {
                cameraControls.style.display = 'none';
            }

            appendMessage({ text: "Dạ thưa, tôi là trợ lý ảo của công ty. Tôi có thể giúp gì cho quý khách ạ?" }, 'bot');
            try {
                const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
                
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                    console.warn("Firebase config is incomplete or invalid. Chat will function without Firestore features.");
                } else {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app); 
                    onAuthStateChanged(auth, user => {
                        userId = user?.uid;
                        isAuthReady = !!user;
                        if (isAuthReady) {
                            console.log("Firebase Auth sẵn sàng. User ID:", userId);
                        }
                    });

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Signed in with custom token.");
                        } catch (tokenError) {
                            console.warn("Custom token sign-in failed, attempting anonymous sign-in:", tokenError);
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously as fallback.");
                        }
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously (no custom token provided).");
                    }
                }
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                appendMessage({ text: `Lỗi: Không thể kết nối đến dịch vụ Firebase. Vui lòng kiểm tra console để biết chi tiết. (${error.message})` }, 'bot', true);
            }

            showChatView();
        };

        // Start the application
        main();
    </script>
</body>
</html>
