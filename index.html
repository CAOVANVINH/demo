<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Ty Thiết Kế In Ấn Hội An</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vanilla-telex@1/vanilla-telex.min.js"></script>
    <style>
        /* Base styles for the body and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fa;
        }
        .dark body {
            background-color: #0d1117;
        }
        #image-input { display: none; }
        .chat-container::-webkit-scrollbar, .modal-body-scroll::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track, .modal-body-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb, .modal-body-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb:hover, .modal-body-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .chat-container::-webkit-scrollbar-thumb, .dark .modal-body-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark .chat-container::-webkit-scrollbar-thumb:hover, .dark .modal-body-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .drag-over {
            background-color: #e0f2fe !important; /* light-blue */
            border: 2px dashed #3b82f6; /* blue-500 */
        }
        .dark .drag-over {
            background-color: #1e3a8a !important; /* dark-blue */
        }
        /* Styles for camera feed */
        #camera-feed {
            width: 100%;
            max-width: 320px; /* Limit camera feed width for better mobile experience */
            height: auto;
            border-radius: 0.75rem; /* rounded-lg */
            margin-bottom: 0.5rem;
            background-color: #000;
            display: none; /* Hidden by default */
        }
        #camera-canvas {
            display: none; /* Hidden, used for capturing frames */
        }
        .camera-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .camera-button {
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .camera-button:hover {
            background-color: #059669; /* green-600 */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .camera-button:disabled {
            background-color: #6ee7b7; /* green-200 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* New UI Styles for Chat Bubbles */
        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .message-fade-in {
            animation: message-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .avatar-container {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .avatar-container svg {
            width: 24px;
            height: 24px;
        }

        /* Typing indicator styles */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dark .typing-dot {
            background-color: #6b7280;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Subtle background pattern */
        .chat-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .chat-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23374151' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>

    <script>
        // Firebase configuration (replace with your actual config if deploying)
        const firebaseConfig = {
          apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8",
          authDomain: "data-chung-a62ee.firebaseapp.com",
          databaseURL: "https://data-chung-a62ee-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "data-chung-a62ee",
          storageBucket: "data-chung-a62ee.firebasestorage.app",
          messagingSenderId: "453115303161",
          appId: "1:4531115303161:web:d40a0ec5a38ab7d4863e28",
          measurementId: "G-WNVH78VY1Z"
        };
        // Expose Firebase config to the global scope for the module script
        window.__firebase_config = JSON.stringify(firebaseConfig);
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[104]">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full mx-4 sm:mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Đăng Nhập Admin</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên đăng nhập:</label>
                    <input type="text" id="admin-username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mật khẩu:</label>
                    <input type="password" id="admin-password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Đăng Nhập</button>
                <button type="button" id="cancel-admin-login-button" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Hủy</button>
            </form>
            <p id="admin-login-error" class="text-red-500 text-sm mt-4 text-center hidden">Tên đăng nhập hoặc mật khẩu không đúng.</p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-view" class="flex h-screen">
        <!-- Sidebar -->
        <aside id="main-sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col justify-between
                                         fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 ease-in-out z-50
                                         md:relative md:translate-x-0 md:flex">
            <div class="p-4">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    </div>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">In Ấn Hội An</h2>
                </div>
                <button id="admin-login-button" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center mb-2">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    Admin Đăng Nhập
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400">
                
                <p>&copy; 2025 Công Ty In Thiết Kế Ấn Hội An</p>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-white dark:bg-gray-800">
            <!-- Chat Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center">
                    <!-- Hamburger menu button for mobile -->
                    <button id="menu-button" class="md:hidden p-2 mr-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="relative mr-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4c-2.23 0-4.14 1.25-5.1 3.05A8.93 8.93 0 0 0 4 9c-2.21 0-4 1.79-4 4s1.79 4 4 4h1v2h-1c-3.31 0-6-2.69-6-6 0-2.95 2.14-5.43 5-5.92V4h1c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h1v2h-1c1.55 0 2.96.59 4 1.54V4h1c1.1 0 2 .9 2 2v1c.73.55 1.39 1.22 1.92 2H23v-1c0-2.21-1.79-4-4-4h-4zm-2 5h-2v2H9v2h2v2h2v-2h2v-2h-2V9z"/></svg>
                        </div>
                        <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-400 ring-2 ring-white dark:ring-gray-800"></span>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white">Trợ Lý Ảo Của Công Ty In Ấn Hội An</h1>
                        <p class="text-xs text-green-500 font-semibold">Đang hoạt động</p>
                    </div>
                </div>
            </header>

            <!-- Chat Messages Container -->
            <div class="chat-container flex-1 p-4 md:p-6 overflow-y-auto chat-bg"></div>

            <!-- Input Area -->
            <div id="input-area" class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-inner">
                <!-- Camera Feed and Controls -->
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-controls">
                    <button id="start-camera-button" class="camera-button">Bật Camera</button>
                    <button id="capture-send-button" class="camera-button" disabled>Chụp Ảnh</button>
                    <button id="switch-camera-button" class="camera-button hidden" disabled>Chuyển Camera</button>
                </div>

                <!-- Image Previews -->
                <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
                
                <!-- Chat Input Form -->
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="file" id="image-input" accept="image/*" multiple>
                    <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </label>
                    <input type="text" id="user-input" placeholder="Dịch, tính giá, 'vẽ' ảnh, hoặc tải ảnh lên..." class="flex-1 p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-all" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white w-12 h-12 rounded-full font-semibold hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:from-blue-400 disabled:to-indigo-400 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0 transition-all duration-200 hover:scale-110 active:scale-100 shadow-lg">
                        <span id="send-text" class="hidden">Gửi</span>
                        <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Admin Panel View -->
    <div id="admin-panel-view" class="flex h-screen hidden">
        <!-- Admin Sidebar -->
        <aside id="admin-sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col justify-between
                                         fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 ease-in-out z-50
                                         md:relative md:translate-x-0 md:flex">
            <div class="p-4">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    </div>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">Admin Panel</h2>
                </div>
                <button id="logout-button" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center mb-4">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7L15.59 8.41l1.59 1.59H9v2h8.18l-1.59 1.59L17 17l5-5-5-5zm-1 12H5V5h11V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11v-2z"/></svg>
                    Đăng Xuất
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400">
                <p>&copy; 2025 Công Ty In Thiết Kế Ấn Hội An</p>
            </div>
        </aside>

        <!-- Overlay for mobile admin sidebar -->
        <div id="admin-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

        <main class="flex-1 flex flex-col bg-white dark:bg-gray-800">
            <!-- Admin Panel Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center">
                    <!-- Hamburger menu button for mobile admin panel -->
                    <button id="admin-menu-button" class="md:hidden p-2 mr-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white">Bảng Điều Khiển Admin</h1>
                </div>
                <!-- New: Back to Chat button -->
                <button id="back-to-chat-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    Quay lại Chat
                </button>
            </header>

            <div class="flex-1 p-6 overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Updated Buttons -->
                    <button id="default-price-management-button" class="admin-panel-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Giá Mặc Định
                    </button>
                     <button id="customer-management-button" class="admin-panel-button bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Quản Lý Khách Hàng
                    </button>
                    <button id="customer-pricing-button" class="admin-panel-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Giá Theo Khách Hàng
                    </button>
                    <button id="sales-management-button" class="admin-panel-button bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Bán Hàng
                    </button>
                    <button id="quotation-management-button" class="admin-panel-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Báo giá
                    </button>
                    <button id="debt-management-button" class="admin-panel-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Quản Lý Công Nợ
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Default Price Management Modal -->
    <div id="price-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[102]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 sm:mx-auto flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Quản Lý Bảng Giá Mặc Định</h2>
                <button id="close-price-modal-button" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>

            <!-- Price List Container -->
            <div id="price-list-container" class="flex-grow mb-6 overflow-y-auto p-2 bg-gray-50 dark:bg-gray-900 rounded-md modal-body-scroll">
                <!-- Prices will be rendered here by JavaScript -->
            </div>

            <!-- Add/Edit Price Form -->
            <form id="price-form" class="flex-shrink-0 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 id="price-form-title" class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Thêm Sản Phẩm Mới</h3>
                <input type="hidden" id="price-id">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label for="price-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên sản phẩm:</label>
                        <input type="text" id="price-name" placeholder="Ví dụ: Decal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="price-value" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Giá / m² (VNĐ):</label>
                        <input type="number" id="price-value" placeholder="Ví dụ: 85000" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-price-edit-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors hidden">Hủy Sửa</button>
                    <button type="submit" id="submit-price-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Thêm Sản Phẩm</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Customer Management Modal -->
    <div id="customer-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[102]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 sm:mx-auto flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Quản Lý Khách Hàng</h2>
                <button id="close-customer-modal-button" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="customer-list-container" class="flex-grow mb-6 overflow-y-auto p-2 bg-gray-50 dark:bg-gray-900 rounded-md modal-body-scroll">
                <!-- Customers will be rendered here -->
            </div>
            <form id="customer-form" class="flex-shrink-0 border-t border-gray-200 dark:border-gray-700 pt-4">
                <h3 id="customer-form-title" class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Thêm Khách Hàng Mới</h3>
                <input type="hidden" id="customer-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên Khách Hàng:</label>
                        <input type="text" id="customer-name" placeholder="Ví dụ: Anh Ba" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">SĐT / Mã Nhận Dạng:</label>
                        <input type="text" id="customer-phone" placeholder="Ví dụ: 0905123456" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" id="cancel-customer-edit-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors hidden">Hủy Sửa</button>
                    <button type="submit" id="submit-customer-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Thêm Khách Hàng</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Customer-Specific Pricing Modal -->
    <div id="customer-pricing-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[102]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-3xl w-full mx-4 sm:mx-auto flex flex-col" style="max-height: 90vh;">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Áp Dụng Giá Riêng Cho Khách Hàng</h2>
                <button id="close-customer-pricing-modal-button" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <!-- UPDATED: Customer Search Input -->
            <div class="flex-shrink-0 mb-4 relative">
                <label for="customer-search-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tìm hoặc Thêm Khách Hàng:</label>
                <input type="text" id="customer-search-input" placeholder="Nhập tên hoặc SĐT để tìm, hoặc nhập tên mới..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <div id="customer-search-results" class="absolute top-full left-0 right-0 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg mt-1 z-10 hidden max-h-48 overflow-y-auto modal-body-scroll">
                    <!-- Search results will be populated here -->
                </div>
            </div>
            <div id="customer-specific-price-list" class="flex-grow overflow-y-auto p-2 bg-gray-50 dark:bg-gray-900 rounded-md modal-body-scroll">
                <p class="text-center text-gray-500 dark:text-gray-400">Hãy chọn một khách hàng để xem hoặc chỉnh sửa giá.</p>
            </div>
             <div class="flex-shrink-0 flex justify-end mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                <button id="save-customer-prices-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">Lưu Bảng Giá Cho Khách Hàng</button>
            </div>
        </div>
    </div>


    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[103]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm text-center mx-4 sm:mx-auto">
            <p id="custom-message-text" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100"></p>
            <button id="custom-message-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- DOM Element Selection ---
        const chatContainer = document.querySelector('.chat-container');
        const chatView = document.getElementById('chat-view');
        const adminPanelView = document.getElementById('admin-panel-view');

        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              sendButton = document.getElementById('send-button'),
              sendIcon = document.getElementById('send-icon'),
              loadingSpinner = document.getElementById('loading-spinner'), imageInput = document.getElementById('image-input'),
              imagePreviewContainer = document.getElementById('image-preview-container'), imageInfo = document.getElementById('image-info'),
              inputArea = document.getElementById('input-area');
        
        // Camera elements
        const cameraFeed = document.getElementById('camera-feed'), cameraCanvas = document.getElementById('camera-canvas'),
              cameraControls = document.querySelector('.camera-controls'), startCameraButton = document.getElementById('start-camera-button'),
              captureSendButton = document.getElementById('capture-send-button'), switchCameraButton = document.getElementById('switch-camera-button');        
        let mediaStream = null, availableVideoDevices = [], currentCameraIndex = -1;        

        // Modals
        const customMessageModal = document.getElementById('custom-message-modal'), customMessageText = document.getElementById('custom-message-text'),
              customMessageOkButton = document.getElementById('custom-message-ok'), adminLoginModal = document.getElementById('admin-login-modal'),
              adminLoginForm = document.getElementById('admin-login-form'), adminUsernameInput = document.getElementById('admin-username'),
              adminPasswordInput = document.getElementById('admin-password'), adminLoginError = document.getElementById('admin-login-error'),
              adminLoginButton = document.getElementById('admin-login-button'), cancelAdminLoginButton = document.getElementById('cancel-admin-login-button');

        // Admin Panel Buttons
        const salesManagementButton = document.getElementById('sales-management-button'), quotationManagementButton = document.getElementById('quotation-management-button'),
              debtManagementButton = document.getElementById('debt-management-button'), logoutButton = document.getElementById('logout-button'),
              backToChatButton = document.getElementById('back-to-chat-button');

        // Sidebar Toggle
        const mainSidebar = document.getElementById('main-sidebar'), menuButton = document.getElementById('menu-button'),
              sidebarOverlay = document.getElementById('sidebar-overlay'), adminSidebar = document.getElementById('admin-sidebar'),
              adminMenuButton = document.getElementById('admin-menu-button'), adminSidebarOverlay = document.getElementById('admin-sidebar-overlay');

        // --- Price Management Elements ---
        const priceManagementModal = document.getElementById('price-management-modal'), defaultPriceManagementButton = document.getElementById('default-price-management-button'),
              closePriceModalButton = document.getElementById('close-price-modal-button'), priceListContainer = document.getElementById('price-list-container'),
              priceForm = document.getElementById('price-form'), priceFormTitle = document.getElementById('price-form-title'),
              priceIdInput = document.getElementById('price-id'), priceNameInput = document.getElementById('price-name'),
              priceValueInput = document.getElementById('price-value'), submitPriceButton = document.getElementById('submit-price-button'),
              cancelPriceEditButton = document.getElementById('cancel-price-edit-button');

        // --- Customer Management Elements ---
        const customerManagementModal = document.getElementById('customer-management-modal'), customerManagementButton = document.getElementById('customer-management-button'),
              closeCustomerModalButton = document.getElementById('close-customer-modal-button'), customerListContainer = document.getElementById('customer-list-container'),
              customerForm = document.getElementById('customer-form'), customerFormTitle = document.getElementById('customer-form-title'),
              customerIdInput = document.getElementById('customer-id'), customerNameInput = document.getElementById('customer-name'),
              customerPhoneInput = document.getElementById('customer-phone'), submitCustomerButton = document.getElementById('submit-customer-button'),
              cancelCustomerEditButton = document.getElementById('cancel-customer-edit-button');

        // --- Customer-Specific Pricing Elements ---
        const customerPricingModal = document.getElementById('customer-pricing-modal'), customerPricingButton = document.getElementById('customer-pricing-button'),
              closeCustomerPricingModalButton = document.getElementById('close-customer-pricing-modal-button'), 
              customerSearchInput = document.getElementById('customer-search-input'), // UPDATED
              customerSearchResults = document.getElementById('customer-search-results'), // NEW
              customerSpecificPriceList = document.getElementById('customer-specific-price-list'), 
              saveCustomerPricesButton = document.getElementById('save-customer-prices-button');


        // --- State Management ---
        const MAX_IMAGES = 100;        
        let chatHistory = [];
        let uploadedImages = [];
        let currentApiKeyIndex = 0;
        let isAdminLoggedIn = false;
        
        // --- Data State ---
        let priceData = [
            { id: 'decal', name: 'Decal', price: 85000 },
            { id: 'bat', name: 'In bạt', price: 70000 },
            { id: 'standee', name: 'Standee', price: 120000 },
        ];
        let customers = [
            { id: 'khach-le-1', name: 'Khách Lẻ', phone: ''},
            { id: 'anh-ba-2', name: 'Anh Ba', phone: '0905111222'},
        ];
        let customerPrices = {
            'anh-ba-2': {
                'decal': 80000, // Anh Ba gets a discount on decals
            }
        };


        // Firebase State
        let app, auth, userId, isAuthReady = false;

        // ===================================================================================
        // !!! API KEY CONFIGURATION !!!
        // ===================================================================================
        const apiKeys = [
            "AIzaSyCg4gg9GLf6SPzhYCNLmvTZyIuuQZPRw04", "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyDxr0SL3tbWE2kdp2oBB3Ru4UxpbuimZD0", "AIzaSyBR-duVUWZG-lD5usabYD3NS_-tZySMlcA",
            "AIzaSyBNagv3kn8vAJzbyMYlvLLCccNGbFa4ySc",
        ];

        // --- Helper Functions ---
        const isMobileDevice = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // --- AI & Chat Logic ---
        const generateSystemInstruction = () => {
            const now = new Date();
            const offset = 7 * 60;
            const localTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (offset * 60000));
            const formattedTime = localTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = localTime.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Generate price lists for the AI
            const defaultPriceListString = priceData.map(item => `- ${item.name}: ${item.price.toLocaleString('vi-VN')} VNĐ/m²`).join('\n');
            
            let customerPriceListString = customers.map(customer => {
                const specificPrices = customerPrices[customer.id];
                if (!specificPrices || Object.keys(specificPrices).length === 0) return null;

                let priceString = `* Khách hàng: ${customer.name} (SĐT/Mã: ${customer.phone || 'Không có'}):\n`;
                priceString += Object.entries(specificPrices).map(([priceId, price]) => {
                    const product = priceData.find(p => p.id === priceId);
                    return product ? `  - ${product.name}: ${price.toLocaleString('vi-VN')} VNĐ/m²` : '';
                }).filter(Boolean).join('\n');
                return priceString;
            }).filter(Boolean).join('\n\n');

            return `Bạn là trợ lý ảo đa năng của Công Ty Thiết Kế In Ấn Hội An.
                    **Hãy luôn trả lời "dạ thưa", đưa ra phản hồi nhanh chóng và đảm bảo kết quả chính xác 100%.**

                    **CÁC CHỨC NĂNG CHÍNH:**

                    1. **DỊCH THUẬT SONG NGỮ**: Dịch chuyên ngành nhà hàng và phổ thông.
                    2. **TRÍCH XUẤT VĂN BẢN (OCR)**: Trích xuất văn bản từ ảnh.
                    3. **TẠO HÌNH ẢNH (IMAGEN)**: Tạo ảnh khi có yêu cầu "vẽ", "tạo ảnh".

                    **4. TÍNH GIÁ IN ẤN (QUAN TRỌNG):**
                    - **Quy trình**:
                      1. Kiểm tra xem người dùng có đề cập đến tên hoặc SĐT của khách hàng trong danh sách giá riêng không.
                      2. Nếu có, và khách hàng đó có giá riêng cho sản phẩm được hỏi, **BẮT BUỘC** sử dụng giá riêng đó.
                      3. Nếu khách hàng không có giá riêng cho sản phẩm đó, hoặc không có khách hàng nào được đề cập, hãy sử dụng **GIÁ MẶC ĐỊNH**.
                    - **Công thức**: (dài * rộng * số lượng) * giá/m². VAT 8% nếu có hóa đơn. Luôn làm tròn và định dạng tiền tệ.

                    ---
                    **BẢNG GIÁ MẶC ĐỊNH (Áp dụng cho mọi khách hàng không có giá riêng):**
                    ${defaultPriceListString}
                    ---
                    **BẢNG GIÁ RIÊNG (Ưu tiên áp dụng nếu khách hàng được nhắc đến):**
                    ${customerPriceListString || "Hiện không có giá riêng cho khách hàng nào."}
                    ---

                    **5. THÔNG TIN CÔNG TY**:
                    - **Địa chỉ:** 69 Đào Duy Từ, Hội An.
                    - **Zalo / SĐT:** 0935 000 442.
                    - **Thời gian hiện tại:** ${formattedTime} ngày ${formattedDate} (GMT+7).

                    **QUAN TRỌNG:** Sau mỗi câu trả lời, trừ khi chỉ dịch thuật, trích xuất văn bản hoặc tạo ảnh, hãy thêm dòng quảng cáo:
                    "---<br>Dạ vâng, quý khách có cần thiết kế hay in ấn chuyên nghiệp tại Hội An không ạ? Hãy liên hệ Công Ty Thiết Kế In Ấn Hội An tại 69 Đào Duy Từ, Zalo/SĐT: 0935 000 442 để được tư vấn và hỗ trợ tốt nhất ạ!"`;
        };

        const getApiResponse = async (url, payload, modelName) => {
             if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) {
                throw new Error("Vui lòng cấu hình API key.");
            }
            
            for (let i = 0; i < apiKeys.length; i++) {
                const apiKey = apiKeys[currentApiKeyIndex];
                const fullUrl = `${url}?key=${apiKey}`;
                
                try {
                    const response = await fetch(fullUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        console.error(`Lỗi API ${modelName} với key ${currentApiKeyIndex}:`, err.error.message);
                        currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                        continue; // Try next key
                    }

                    const result = await response.json();
                    if (modelName === 'Gemini' && result.candidates?.[0]?.content?.parts) {
                        return result.candidates[0].content.parts[0].text;
                    }
                    if (modelName === 'Imagen' && result.predictions?.[0]?.bytesBase64Encoded) {
                         return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    }
                    if (result.promptFeedback?.blockReason) {
                        return `Yêu cầu bị chặn: ${result.promptFeedback.blockReason}.`;
                    }
                    
                    console.warn(`${modelName} API key ${currentApiKeyIndex} trả về phản hồi không hợp lệ.`);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                    
                } catch (error) {
                    console.error(`Lỗi mạng hoặc fetch với key ${currentApiKeyIndex} cho ${modelName}:`, error.message);
                    currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                }
            }
            throw new Error(`Tất cả API key cho ${modelName} đều không hoạt động.`);
        };

        const getGeminiResponse = () => getApiResponse('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', { contents: chatHistory, systemInstruction: { parts: [{ text: generateSystemInstruction() }] } }, 'Gemini');
        const getImagenResponse = (prompt) => getApiResponse('https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict', { instances: [{ prompt }], parameters: { "sampleCount": 1 } }, 'Imagen');


        // --- View Control Functions ---
        function showChatView() {
            chatView.classList.remove('hidden');
            adminPanelView.classList.add('hidden');
        }

        function showAdminPanelView() {
            chatView.classList.add('hidden');
            adminPanelView.classList.remove('hidden');
        }

        // --- Camera Functions (abbreviated for brevity, no changes) ---
        async function stopCamera() { if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; cameraFeed.style.display = 'none'; startCameraButton.textContent = 'Bật Camera'; captureSendButton.disabled = true; switchCameraButton.classList.add('hidden'); } }
        async function startCamera() { /* ... full implementation ... */ }
        startCameraButton.addEventListener('click', async () => { if (mediaStream && mediaStream.active) stopCamera(); else await startCamera(); });
        // ... other camera handlers ...

        // --- UI & Event Handlers ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let message = userInput.value.trim();
            const imagesToSubmit = [...uploadedImages];

            if (!message && imagesToSubmit.length === 0) return showCustomMessage("Vui lòng nhập tin nhắn hoặc tải lên ảnh.", "warning");

            const imageGenKeywords = ['vẽ ', 'tạo ảnh ', 'generate '];
            const imageGenKeyword = imageGenKeywords.find(kw => message.toLowerCase().startsWith(kw));

            toggleLoading(true);
            if (imageGenKeyword && imagesToSubmit.length === 0) {
                const imagePrompt = message.substring(imageGenKeyword.length);
                appendMessage({ text: message }, 'user');
                userInput.value = '';
                showTypingIndicator(true, 'Đang vẽ ảnh...');
                try {
                    const imageUrl = await getImagenResponse(imagePrompt);
                    appendMessage({ generatedImage: imageUrl, prompt: imagePrompt }, 'bot');
                } catch (error) {
                    appendMessage({ text: `Rất tiếc, không thể tạo ảnh: ${error.message}` }, 'bot', true);
                }
            } else {
                if (imagesToSubmit.length > 0 && !message) message = "Trích xuất văn bản từ ảnh.";
                appendMessage({ text: message, images: imagesToSubmit }, 'user');
                userInput.value = '';
                imagePreviewContainer.innerHTML = '';
                uploadedImages = [];
                updateImageCount();
                showTypingIndicator(true);

                const userPartsForAPI = [{ text: message }];
                const imagePromises = imagesToSubmit.map(file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve({ inlineData: { mimeType: file.type, data: e.target.result.split(',')[1] } });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
                
                try {
                    const resolvedImages = await Promise.all(imagePromises);
                    userPartsForAPI.push(...resolvedImages);
                    chatHistory.push({ role: "user", parts: userPartsForAPI });
                    const botResponse = await getGeminiResponse();
                    appendMessage({ text: botResponse }, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                } catch (error) {
                    appendMessage({ text: `Lỗi: ${error.message}` }, 'bot', true);
                }
            }
            toggleLoading(false);
            showTypingIndicator(false);
        });
        
        function showCustomMessage(message) { customMessageText.textContent = message; customMessageModal.classList.remove('hidden'); }
        customMessageOkButton.addEventListener('click', () => customMessageModal.classList.add('hidden'));

        function processFiles(files) { /* ... full implementation ... */ }
        imageInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        userInput.addEventListener('paste', (e) => { processFiles(e.clipboardData?.files); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.remove('drag-over')));
        inputArea.addEventListener('drop', (e) => { processFiles(e.dataTransfer?.files); });
        
        function createImagePreview(dataUrl, file) { /* ... full implementation ... */ }
        function updateImageCount() { /* ... full implementation ... */ }
        
        function showTypingIndicator(show, customText = '') { /* ... full implementation ... */ }
        function appendMessage(data, sender, isError = false) { /* ... full implementation from previous version, no changes needed ... */ }
        function toggleLoading(isLoading) { /* ... full implementation from previous version, no changes needed ... */ }

        // --- Admin Login & Panel Logic ---
        adminLoginButton.addEventListener('click', () => { adminLoginModal.classList.remove('hidden'); adminUsernameInput.value = 'admin'; adminPasswordInput.value = 'admin'; adminLoginError.classList.add('hidden'); adminUsernameInput.focus(); });
        cancelAdminLoginButton.addEventListener('click', () => adminLoginModal.classList.add('hidden'));
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (adminUsernameInput.value === 'admin' && adminPasswordInput.value === 'admin') {
                isAdminLoggedIn = true;
                adminLoginModal.classList.add('hidden');
                showCustomMessage('Đăng nhập Admin thành công!');
                showAdminPanelView();
            } else {
                adminLoginError.classList.remove('hidden');
            }
        });
        const showUnderDevelopmentMessage = () => showCustomMessage('Chức năng đang phát triển.');
        salesManagementButton.addEventListener('click', showUnderDevelopmentMessage);
        quotationManagementButton.addEventListener('click', showUnderDevelopmentMessage);
        debtManagementButton.addEventListener('click', showUnderDevelopmentMessage);
        logoutButton.addEventListener('click', () => { isAdminLoggedIn = false; showChatView(); showCustomMessage('Đã đăng xuất.'); });
        backToChatButton.addEventListener('click', showChatView);

        // --- Sidebar Toggle Logic ---
        function toggleSidebar() { mainSidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); }
        menuButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        function toggleAdminSidebar() { adminSidebar.classList.toggle('-translate-x-full'); adminSidebarOverlay.classList.toggle('hidden'); }
        adminMenuButton.addEventListener('click', toggleAdminSidebar);
        adminSidebarOverlay.addEventListener('click', toggleAdminSidebar);

        // --- Default Price Management Logic ---
        function renderPriceList() {
            priceListContainer.innerHTML = '';
            priceData.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700';
                itemEl.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${item.name}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${item.price.toLocaleString('vi-VN')} VNĐ / m²</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${item.id}" class="edit-price-btn text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button data-id="${item.id}" class="delete-price-btn text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>`;
                priceListContainer.appendChild(itemEl);
            });
        }
        function resetPriceForm() { priceForm.reset(); priceIdInput.value = ''; priceFormTitle.textContent = 'Thêm Sản Phẩm Mới'; submitPriceButton.textContent = 'Thêm Sản Phẩm'; cancelPriceEditButton.classList.add('hidden'); }
        function editPrice(id) {
            const item = priceData.find(p => p.id === id);
            if (item) { priceIdInput.value = item.id; priceNameInput.value = item.name; priceValueInput.value = item.price; priceFormTitle.textContent = 'Sửa Sản Phẩm'; submitPriceButton.textContent = 'Cập Nhật'; cancelPriceEditButton.classList.remove('hidden'); priceNameInput.focus(); }
        }
        function deletePrice(id) { priceData = priceData.filter(p => p.id !== id); renderPriceList(); showCustomMessage('Đã xóa sản phẩm.'); }
        priceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = priceIdInput.value, name = priceNameInput.value.trim(), price = parseInt(priceValueInput.value, 10);
            if (!name || isNaN(price) || price < 0) return showCustomMessage('Vui lòng nhập tên và giá hợp lệ.');
            if (id) { const idx = priceData.findIndex(p => p.id === id); if (idx > -1) priceData[idx] = { id, name, price }; } 
            else { const newId = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now(); priceData.push({ id: newId, name, price }); }
            renderPriceList(); resetPriceForm();
        });
        priceListContainer.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-price-btn');
            const deleteBtn = e.target.closest('.delete-price-btn');
            if (editBtn) editPrice(editBtn.dataset.id);
            if (deleteBtn) deletePrice(deleteBtn.dataset.id);
        });
        defaultPriceManagementButton.addEventListener('click', () => { priceManagementModal.classList.remove('hidden'); renderPriceList(); resetPriceForm(); });
        closePriceModalButton.addEventListener('click', () => priceManagementModal.classList.add('hidden'));
        cancelPriceEditButton.addEventListener('click', resetPriceForm);

        // --- Customer Management Logic ---
        function renderCustomerList() {
            customerListContainer.innerHTML = '';
            customers.forEach(c => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700';
                el.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${c.name}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">SĐT/Mã: ${c.phone || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${c.id}" class="edit-customer-btn text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button data-id="${c.id}" class="delete-customer-btn text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>`;
                customerListContainer.appendChild(el);
            });
        }
        function resetCustomerForm() { customerForm.reset(); customerIdInput.value = ''; customerFormTitle.textContent = 'Thêm Khách Hàng Mới'; submitCustomerButton.textContent = 'Thêm Khách Hàng'; cancelCustomerEditButton.classList.add('hidden'); }
        function editCustomer(id) {
            const c = customers.find(cust => cust.id === id);
            if (c) { customerIdInput.value = c.id; customerNameInput.value = c.name; customerPhoneInput.value = c.phone; customerFormTitle.textContent = 'Sửa Khách Hàng'; submitCustomerButton.textContent = 'Cập Nhật'; cancelCustomerEditButton.classList.remove('hidden'); customerNameInput.focus(); }
        }
        function deleteCustomer(id) { customers = customers.filter(c => c.id !== id); delete customerPrices[id]; renderCustomerList(); showCustomMessage('Đã xóa khách hàng.'); }
        customerForm.addEventListener('submit', e => {
            e.preventDefault();
            const id = customerIdInput.value, name = customerNameInput.value.trim(), phone = customerPhoneInput.value.trim();
            if (!name) return showCustomMessage('Vui lòng nhập tên khách hàng.');
            if (id) { const idx = customers.findIndex(c => c.id === id); if (idx > -1) customers[idx] = { id, name, phone }; } 
            else { const newId = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now(); customers.push({ id: newId, name, phone }); }
            renderCustomerList(); resetCustomerForm();
        });
        customerListContainer.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-customer-btn');
            const deleteBtn = e.target.closest('.delete-customer-btn');
            if (editBtn) editCustomer(editBtn.dataset.id);
            if (deleteBtn) deleteCustomer(deleteBtn.dataset.id);
        });
        customerManagementButton.addEventListener('click', () => { customerManagementModal.classList.remove('hidden'); renderCustomerList(); resetCustomerForm(); });
        closeCustomerModalButton.addEventListener('click', () => customerManagementModal.classList.add('hidden'));
        cancelCustomerEditButton.addEventListener('click', resetCustomerForm);

        // --- Customer-Specific Pricing Logic (UPDATED) ---
        function renderCustomerPriceList(customerId) {
            customerSpecificPriceList.innerHTML = '';
            if (!customerId) {
                customerSpecificPriceList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Hãy chọn hoặc tìm một khách hàng để xem/sửa giá.</p>';
                saveCustomerPricesButton.classList.add('hidden');
                return;
            }
            saveCustomerPricesButton.classList.remove('hidden');
            const specificPrices = customerPrices[customerId] || {};
            priceData.forEach(p => {
                const customPrice = specificPrices[p.id];
                const el = document.createElement('div');
                el.className = 'grid grid-cols-3 gap-4 items-center p-3 border-b border-gray-200 dark:border-gray-700';
                el.innerHTML = `
                    <div class="col-span-1">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${p.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Mặc định: ${p.price.toLocaleString('vi-VN')}đ</p>
                    </div>
                    <div class="col-span-2 flex items-center gap-2">
                        <input type="number" data-price-id="${p.id}" value="${customPrice !== undefined ? customPrice : ''}" placeholder="Dùng giá mặc định" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        ${customPrice !== undefined ? `<button data-price-id="${p.id}" class="reset-customer-price-btn text-gray-400 hover:text-red-500 p-1 rounded-full" title="Reset về giá mặc định">&circlearrowleft;</button>` : ''}
                    </div>
                `;
                customerSpecificPriceList.appendChild(el);
            });
        }

        customerPricingButton.addEventListener('click', () => {
            customerPricingModal.classList.remove('hidden');
            customerSearchInput.value = '';
            delete customerSearchInput.dataset.selectedId;
            renderCustomerPriceList(null);
        });

        closeCustomerPricingModalButton.addEventListener('click', () => customerPricingModal.classList.add('hidden'));

        customerSearchInput.addEventListener('input', () => {
            const searchTerm = customerSearchInput.value.toLowerCase();
            delete customerSearchInput.dataset.selectedId; // Clear selection when user types
            saveCustomerPricesButton.classList.remove('hidden'); // Allow saving new customer

            if (!searchTerm) {
                customerSearchResults.classList.add('hidden');
                renderCustomerPriceList(null);
                return;
            }

            const filteredCustomers = customers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || c.phone.includes(searchTerm)
            );

            customerSearchResults.innerHTML = '';
            if (filteredCustomers.length > 0) {
                filteredCustomers.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-indigo-100 dark:hover:bg-indigo-900 cursor-pointer';
                    item.textContent = `${c.name} (${c.phone || 'N/A'})`;
                    item.dataset.id = c.id;
                    item.dataset.name = c.name;
                    item.addEventListener('click', () => {
                        customerSearchInput.value = item.dataset.name;
                        customerSearchInput.dataset.selectedId = item.dataset.id;
                        customerSearchResults.classList.add('hidden');
                        renderCustomerPriceList(item.dataset.id);
                    });
                    customerSearchResults.appendChild(item);
                });
                customerSearchResults.classList.remove('hidden');
            } else {
                customerSearchResults.classList.add('hidden');
                renderCustomerPriceList(null); // Clear price list as it's a new customer
            }
        });

        customerSpecificPriceList.addEventListener('click', e => {
            const resetBtn = e.target.closest('.reset-customer-price-btn');
            if(resetBtn) {
                const customerId = customerSearchInput.dataset.selectedId;
                const priceId = resetBtn.dataset.priceId;
                if (customerId && priceId && customerPrices[customerId]) {
                    delete customerPrices[customerId][priceId];
                    if(Object.keys(customerPrices[customerId]).length === 0) {
                        delete customerPrices[customerId];
                    }
                    renderCustomerPriceList(customerId);
                }
            }
        });

        saveCustomerPricesButton.addEventListener('click', () => {
            let customerId = customerSearchInput.dataset.selectedId;
            const customerName = customerSearchInput.value.trim();

            if (!customerName) {
                showCustomMessage("Vui lòng nhập hoặc chọn một khách hàng.");
                return;
            }

            // If no customer is selected from dropdown, check if it's a new one
            if (!customerId) {
                // Check if name already exists to avoid duplicates
                const existingCustomer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                if (existingCustomer) {
                    customerId = existingCustomer.id;
                } else {
                    // Create new customer
                    const newId = customerName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                    customers.push({ id: newId, name: customerName, phone: '' });
                    customerId = newId;
                    showCustomMessage(`Đã tạo khách hàng mới: ${customerName}`);
                }
                customerSearchInput.dataset.selectedId = customerId; // Set the ID for future saves in this session
            }
            
            const inputs = customerSpecificPriceList.querySelectorAll('input[data-price-id]');
            if (!customerPrices[customerId]) customerPrices[customerId] = {};

            inputs.forEach(input => {
                const priceId = input.dataset.priceId;
                const value = input.value.trim();
                
                if (value === '') {
                    delete customerPrices[customerId][priceId];
                } else {
                    const price = parseInt(value, 10);
                    if (!isNaN(price) && price >= 0) {
                        customerPrices[customerId][priceId] = price;
                    }
                }
            });
            
            if (Object.keys(customerPrices[customerId]).length === 0) {
                delete customerPrices[customerId];
            }

            showCustomMessage('Đã lưu bảng giá riêng cho khách hàng!');
            renderCustomerPriceList(customerId);
        });


        // --- App Initialization ---
        const main = async () => {
            if (!isMobileDevice()) cameraControls.style.display = 'none';
            appendMessage({ text: "Dạ thưa, tôi là trợ lý ảo đa năng. Tôi có thể dịch thuật, tính giá, tạo ảnh, hoặc trích xuất văn bản từ ảnh. Quý khách cần hỗ trợ gì ạ?" }, 'bot');
            try {
                const fbConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
                if (fbConfig?.apiKey) {
                    app = initializeApp(fbConfig);
                    auth = getAuth(app); 
                    onAuthStateChanged(auth, user => { userId = user?.uid; isAuthReady = !!user; if(isAuthReady) console.log("Firebase Auth Sẵn Sàng. User ID:", userId); });
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try { await signInWithCustomToken(auth, __initial_auth_token); } catch { await signInAnonymously(auth); }
                    } else { await signInAnonymously(auth); }
                }
            } catch (error) { console.error("Lỗi khởi tạo Firebase:", error); }
            showChatView();
        };

        main();
    </script>
</body>
</html>
