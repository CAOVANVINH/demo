<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Ty Thiết Kế In Ấn Hội An</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vanilla-telex@1/vanilla-telex.min.js"></script>
    <style>
        /* Base styles for the body and scrollbar */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fa;
        }
        .dark body {
            background-color: #0d1117;
        }
        #image-input { display: none; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .chat-container::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark .chat-container::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .drag-over {
            background-color: #e0f2fe !important; /* light-blue */
            border: 2px dashed #3b82f6; /* blue-500 */
        }
        .dark .drag-over {
            background-color: #1e3a8a !important; /* dark-blue */
        }
        /* Styles for camera feed */
        #camera-feed {
            width: 100%;
            max-width: 320px; /* Limit camera feed width for better mobile experience */
            height: auto;
            border-radius: 0.75rem; /* rounded-lg */
            margin-bottom: 0.5rem;
            background-color: #000;
            display: none; /* Hidden by default */
        }
        #camera-canvas {
            display: none; /* Hidden, used for capturing frames */
        }
        .camera-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .camera-button {
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .camera-button:hover {
            background-color: #059669; /* green-600 */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .camera-button:disabled {
            background-color: #6ee7b7; /* green-200 */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* New UI Styles for Chat Bubbles */
        @keyframes message-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .message-fade-in {
            animation: message-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .avatar-container {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .avatar-container svg {
            width: 24px;
            height: 24px;
        }

        /* Typing indicator styles */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dark .typing-dot {
            background-color: #6b7280;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Subtle background pattern */
        .chat-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e5e7eb' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .chat-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23374151' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>

    <script>
        // Firebase configuration (replace with your actual config if deploying)
        const firebaseConfig = {
          apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8",
          authDomain: "data-chung-a62ee.firebaseapp.com",
          databaseURL: "https://data-chung-a62ee-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "data-chung-a62ee",
          storageBucket: "data-chung-a62ee.appspot.com",
          messagingSenderId: "453115303161",
          appId: "1:4531115303161:web:d40a0ec5a38ab7d4863e28",
          measurementId: "G-WNVH78VY1Z"
        };
        // Expose Firebase config to the global scope for the module script
        window.__firebase_config = JSON.stringify(firebaseConfig);
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[101]">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full mx-4 sm:mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Đăng Nhập Admin</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên đăng nhập:</label>
                    <input type="text" id="admin-username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mật khẩu:</label>
                    <input type="password" id="admin-password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Đăng Nhập</button>
                <button type="button" id="cancel-admin-login-button" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Hủy</button>
            </form>
            <p id="admin-login-error" class="text-red-500 text-sm mt-4 text-center hidden">Tên đăng nhập hoặc mật khẩu không đúng.</p>
        </div>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-view" class="flex h-screen">
        <!-- Sidebar -->
        <aside id="main-sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col justify-between
                                        fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 flex">
            <div class="p-4">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    </div>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">In Ấn Hội An</h2>
                </div>
                <button id="admin-login-button" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center mb-2">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    Admin Đăng Nhập
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400">
                
                <p>&copy; 2025 Công Ty In Thiết Kế Ấn Hội An</p>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-white dark:bg-gray-800">
            <!-- Chat Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center">
                    <!-- Hamburger menu button for mobile -->
                    <button id="menu-button" class="p-2 mr-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="relative mr-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4c-2.23 0-4.14 1.25-5.1 3.05A8.93 8.93 0 0 0 4 9c-2.21 0-4 1.79-4 4s1.79 4 4 4h1v2h-1c-3.31 0-6-2.69-6-6 0-2.95 2.14-5.43 5-5.92V4h1c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h1v2h-1c1.55 0 2.96.59 4 1.54V4h1c1.1 0 2 .9 2 2v1c.73.55 1.39 1.22 1.92 2H23v-1c0-2.21-1.79-4-4-4h-4zm-2 5h-2v2H9v2h2v2h2v-2h2v-2h-2V9z"/></svg>
                        </div>
                        <span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-green-400 ring-2 ring-white dark:ring-gray-800"></span>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white">Công Ty Thiết Kế In Ấn Hội An</h1>
                        <p class="text-xs text-green-500 font-semibold">Đang hoạt động</p>
                    </div>
                </div>
            </header>

            <!-- Chat Messages Container -->
            <div class="chat-container flex-1 p-4 md:p-6 overflow-y-auto chat-bg"></div>

            <!-- Input Area -->
            <div id="input-area" class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-inner">
                <!-- Camera Feed and Controls -->
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-controls">
                    <button id="start-camera-button" class="camera-button">Bật Camera</button>
                    <button id="capture-send-button" class="camera-button" disabled>Chụp Ảnh</button>
                    <button id="switch-camera-button" class="camera-button hidden" disabled>Chuyển Camera</button>
                </div>

                <!-- Image Previews -->
                <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
                
                <!-- Chat Input Form -->
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="file" id="image-input" accept="image/*" multiple>
                    <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </label>
                    <input type="text" id="user-input" placeholder="Hỏi về máy in, in ấn, dịch thuật, hoặc tải ảnh lên..." class="flex-1 p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-all" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white w-12 h-12 rounded-full font-semibold hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:from-blue-400 disabled:to-indigo-400 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0 transition-all duration-200 hover:scale-110 active:scale-100 shadow-lg">
                        <span id="send-text" class="hidden">Gửi</span>
                        <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Admin Panel View -->
    <div id="admin-panel-view" class="flex h-screen hidden">
        <!-- Admin Sidebar -->
        <aside id="admin-sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col justify-between
                                        fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 ease-in-out z-50
                                        md:relative md:translate-x-0 md:flex">
            <div class="p-4">
                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center mr-3 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    </div>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white">Admin Panel</h2>
                </div>
                <button id="logout-button" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center mb-4">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 7L15.59 8.41l1.59 1.59H9v2h8.18l-1.59 1.59L17 17l5-5-5-5zm-1 12H5V5h11V3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11v-2z"/></svg>
                    Đăng Xuất
                </button>
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400">
                <p>&copy; 2025 Công Ty In Thiết Kế Ấn Hội An</p>
            </div>
        </aside>

        <!-- Overlay for mobile admin sidebar -->
        <div id="admin-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

        <main class="flex-1 flex flex-col bg-white dark:bg-gray-800">
            <!-- Admin Panel Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gray-800 shadow-sm z-10">
                <div class="flex items-center">
                    <!-- Hamburger menu button for mobile admin panel -->
                    <button id="admin-menu-button" class="md:hidden p-2 mr-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="admin-panel-title" class="text-lg md:text-xl font-bold text-gray-800 dark:text-white">Bảng Điều Khiển Admin</h1>
                </div>
                <!-- New: Back to Chat button -->
                <button id="back-to-chat-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    Quay lại Chat
                </button>
            </header>

            <div id="admin-main-content" class="flex-1 p-6 overflow-y-auto">
                <!-- Main Admin Panel Grid -->
                <div id="admin-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <button id="price-management-button" class="admin-panel-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Quản Lý Giá
                    </button>
                    <button id="sales-management-button" class="admin-panel-button bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Bán Hàng
                    </button>
                    <button id="quotation-management-button" class="admin-panel-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Báo giá
                    </button>
                    <button id="debt-management-button" class="admin-panel-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        Quản Lý Công Nợ
                    </button>
                </div>

                <!-- Price Management Section (Initially Hidden) -->
                <div id="price-management-section" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-gray-100">Quản Lý Giá</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="default-price-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg text-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            Giá Mặc Định
                        </button>
                        <button id="custom-price-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg text-lg shadow-md transition-all duration-200 transform hover:scale-105">
                            Giá Tùy Chỉnh
                        </button>
                    </div>
                    <button id="back-to-admin-dashboard-button" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        Quay lại Bảng Điều Khiển
                    </button>
                </div>

                <!-- Default Price Display Section (Initially Hidden) -->
                <div id="default-price-display-section" class="hidden mt-6 p-6 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Giá vật liệu</h3>
                    <div id="price-list" class="space-y-3">
                        <!-- Prices will be loaded here dynamically -->
                        <p class="text-gray-600 dark:text-gray-300" id="no-prices-message">Chưa có giá vật liệu nào được thêm.</p>
                    </div>
                    <button id="add-new-price-button" class="mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Thêm Giá Vật Liệu Mới
                    </button>
                    <button id="back-to-price-management-button" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        Quay lại Quản Lý Giá
                    </button>
                </div>
                
                <!-- NEW: Sales Management Section (Initially Hidden) -->
                <div id="sales-management-section" class="hidden">
                    <!-- Sales Form -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-md mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Tạo Đơn Hàng Mới</h3>
                        <form id="sales-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Customer Info -->
                            <div class="md:col-span-1">
                                <label for="customer-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên khách hàng:</label>
                                <input type="text" id="customer-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white" required>
                            </div>
                            <div class="md:col-span-1">
                                <label for="customer-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Số điện thoại:</label>
                                <input type="text" id="customer-phone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            </div>

                            <!-- Item Entry -->
                            <div class="md:col-span-2 border-t border-gray-200 dark:border-gray-600 pt-6">
                                <h4 class="text-lg font-medium mb-2 text-gray-800 dark:text-gray-200">Thêm mục vào đơn hàng</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-end">
                                    <div class="sm:col-span-3">
                                        <label for="item-name" class="block text-sm font-medium">Tên mục:</label>
                                        <input type="text" id="item-name" list="default-items-list" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                        <datalist id="default-items-list"></datalist>
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label for="item-width" class="block text-sm font-medium">Rộng (m):</label>
                                        <input type="number" id="item-width" step="0.01" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <label for="item-height" class="block text-sm font-medium">Dài (m):</label>
                                        <input type="number" id="item-height" step="0.01" min="0" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div class="sm:col-span-1">
                                        <label for="item-quantity" class="block text-sm font-medium">SL:</label>
                                        <input type="number" id="item-quantity" value="1" min="1" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                    </div>
                                     <div class="sm:col-span-2">
                                        <label for="item-price" class="block text-sm font-medium">Đơn giá:</label>
                                        <input type="number" id="item-price" min="0" placeholder="VNĐ/m² hoặc /cái" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div class="sm:col-span-2">
                                        <button type="button" id="add-order-item-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg transition-colors flex items-center justify-center">
                                            <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Thêm
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="mt-6">
                            <h4 class="text-lg font-medium mb-2 text-gray-800 dark:text-gray-200">Các mục trong đơn hàng:</h4>
                            <div id="current-order-items" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                <p class="text-gray-500 dark:text-gray-400">Chưa có mục nào.</p>
                            </div>
                        </div>

                        <div class="mt-6 border-t border-gray-200 dark:border-gray-600 pt-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="order-deposit" class="block text-sm font-medium">Cọc trước (VNĐ):</label>
                                <input type="number" id="order-deposit" min="0" value="0" class="w-full mt-1 max-w-xs px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white">
                            </div>
                            <div class="text-right space-y-2">
                                <p class="text-gray-600 dark:text-gray-300">Tổng cộng: <span id="order-total" class="font-bold text-xl text-gray-900 dark:text-white">0 VNĐ</span></p>
                                <p class="text-gray-600 dark:text-gray-300">Còn lại: <span id="order-remaining" class="font-bold text-2xl text-green-600 dark:text-green-400">0 VNĐ</span></p>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end gap-4">
                            <button type="button" id="clear-order-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Xóa Đơn</button>
                            <button type="button" id="save-order-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Lưu Đơn Hàng</button>
                        </div>
                    </div>
                    
                    <div id="recent-orders-section" class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Đơn Hàng Gần Đây</h3>
                        <div id="recent-orders-list" class="space-y-4">
                            <p class="text-gray-500 dark:text-gray-400">Đang tải đơn hàng...</p>
                        </div>
                    </div>
                    
                    <button id="back-to-admin-dashboard-from-sales-button" class="mt-8 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        Quay lại Bảng Điều Khiển
                    </button>
                </div>

            </div>
        </main>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm text-center mx-4 sm:mx-auto">
            <p id="custom-message-text" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100"></p>
            <div class="flex justify-center gap-4">
                <button id="custom-message-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                <button id="custom-message-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg hidden">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Price Modal (Initially Hidden) -->
    <div id="price-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-[102]">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full mx-4 sm:mx-auto">
            <h2 id="price-form-title" class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-gray-100">Thêm Giá Mới</h2>
            <form id="price-form">
                <input type="hidden" id="price-id">
                <div class="mb-4">
                    <label for="price-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên mục:</label>
                    <input type="text" id="price-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div class="mb-4">
                    <label for="price-value" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Giá trị (VNĐ/m²):</label>
                    <input type="number" id="price-value" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required min="0">
                </div>
                <button type="submit" id="save-price-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Lưu</button>
                <button type="button" id="cancel-price-button" class="w-full mt-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Hủy</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, query, where, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Element Selection ---
        const chatContainer = document.querySelector('.chat-container');
        const chatView = document.getElementById('chat-view'); // Get chat view container
        const adminPanelView = document.getElementById('admin-panel-view'); // Get admin panel container

        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              sendButton = document.getElementById('send-button'), sendText = document.getElementById('send-text'),
              sendIcon = document.getElementById('send-icon'),
              loadingSpinner = document.getElementById('loading-spinner'), imageInput = document.getElementById('image-input'),
              imagePreviewContainer = document.getElementById('image-preview-container'), imageInfo = document.getElementById('image-info'),
              inputArea = document.getElementById('input-area');
        
        // Camera elements
        const cameraFeed = document.getElementById('camera-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const cameraControls = document.querySelector('.camera-controls');
        const startCameraButton = document.getElementById('start-camera-button');
        const captureSendButton = document.getElementById('capture-send-button');
        const switchCameraButton = document.getElementById('switch-camera-button');        
        let mediaStream = null;        
        let availableVideoDevices = [];        
        let currentCameraIndex = -1;        

        // Modals
        const customMessageModal = document.getElementById('custom-message-modal');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageOkButton = document.getElementById('custom-message-ok');
        const customMessageCancelButton = document.getElementById('custom-message-cancel'); // New cancel button for custom message modal
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminLoginButton = document.getElementById('admin-login-button');
        const cancelAdminLoginButton = document.getElementById('cancel-admin-login-button');


        // Admin Panel Buttons
        const adminDashboard = document.getElementById('admin-dashboard'); // Main admin dashboard grid
        const priceManagementButton = document.getElementById('price-management-button');
        const salesManagementButton = document.getElementById('sales-management-button');
        const quotationManagementButton = document.getElementById('quotation-management-button');
        const debtManagementButton = document.getElementById('debt-management-button');
        const logoutButton = document.getElementById('logout-button');
        const backToChatButton = document.getElementById('back-to-chat-button');
        const adminPanelTitle = document.getElementById('admin-panel-title'); // Admin panel title

        // Price Management Section Elements
        const priceManagementSection = document.getElementById('price-management-section');
        const defaultPriceButton = document.getElementById('default-price-button');
        const customPriceButton = document.getElementById('custom-price-button');
        const backToAdminDashboardButton = document.getElementById('back-to-admin-dashboard-button');

        // Default Price Display Section Elements
        const defaultPriceDisplaySection = document.getElementById('default-price-display-section');
        const backToPriceManagementButton = document.getElementById('back-to-price-management-button');
        const addNewPriceButton = document.getElementById('add-new-price-button');
        const priceListContainer = document.getElementById('price-list');
        const noPricesMessage = document.getElementById('no-prices-message');

        // Price Management CRUD Elements
        const priceFormModal = document.getElementById('price-form-modal');
        const priceFormTitle = document.getElementById('price-form-title');
        const priceForm = document.getElementById('price-form');
        const priceIdInput = document.getElementById('price-id');
        const priceNameInput = document.getElementById('price-name');
        const priceValueInput = document.getElementById('price-value');
        const savePriceButton = document.getElementById('save-price-button');
        const cancelPriceButton = document.getElementById('cancel-price-button');

        // Sales Management Section Elements
        const salesManagementSection = document.getElementById('sales-management-section');
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const itemNameInput = document.getElementById('item-name');
        const defaultItemsDatalist = document.getElementById('default-items-list');
        const itemWidthInput = document.getElementById('item-width');
        const itemHeightInput = document.getElementById('item-height');
        const itemQuantityInput = document.getElementById('item-quantity');
        const itemPriceInput = document.getElementById('item-price');
        const addOrderItemButton = document.getElementById('add-order-item-button');
        const currentOrderItemsContainer = document.getElementById('current-order-items');
        const orderDepositInput = document.getElementById('order-deposit');
        const orderTotalSpan = document.getElementById('order-total');
        const orderRemainingSpan = document.getElementById('order-remaining');
        const clearOrderButton = document.getElementById('clear-order-button');
        const saveOrderButton = document.getElementById('save-order-button');
        const recentOrdersListContainer = document.getElementById('recent-orders-list');
        const backToAdminDashboardFromSalesButton = document.getElementById('back-to-admin-dashboard-from-sales-button');

        // Sidebar Toggle Elements
        const mainSidebar = document.getElementById('main-sidebar');
        const menuButton = document.getElementById('menu-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const adminSidebar = document.getElementById('admin-sidebar');
        const adminMenuButton = document.getElementById('admin-menu-button');
        const adminSidebarOverlay = document.getElementById('admin-sidebar-overlay');


        // --- State Management ---
        const MAX_IMAGES = 100;        
        let chatHistory = [];
        let uploadedImages = []; // Single source of truth for all images (uploaded or captured)
        let currentApiKeyIndex = 0;
        let isAdminLoggedIn = false; // New state for admin login
        let currentDefaultPrices = {}; // Stores prices fetched from Firestore for AI system instruction and sales form
        let currentOrder = { items: [], totalAmount: 0, deposit: 0, remainingAmount: 0 };


        // Firebase State
        let app, db, auth, userId;
        let isAuthReady = false;
        let defaultPricesCollectionRef;
        let adminSettingsDocRef;
        let salesOrdersCollectionRef;

        // ===================================================================================
        // !!! API KEY CONFIGURATION !!!
        // ===================================================================================
        const apiKeys = [
            "AIzaSyBssIyZlGDUo-IbrFCtBT5k-tE21AgQh-0",
            "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyCg4gg9GLf6SPzhYCNLUtmnk4PrfNeA7UE7qq1FZ84X8",
            "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyDxr0SL3tbWE2kdp2oBB3Ru4UxpbuimZD0",
            "AIzaSyBR-duVUWZG-lD5usabYD3NS_-tZySMlcA",
            "AIzaSyBNagv3kn8vAJzbyMYlvLLCccNGbFa4ySc",
        ];

        // --- Helper Functions ---
        const isMobileDevice = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);

        // --- AI & Chat Logic ---
        const generateSystemInstruction = () => {
            const now = new Date();
            const offset = 7 * 60; 
            const localTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (offset * 60000));
            const formattedTime = localTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const formattedDate = localTime.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            let priceListForAI = '';
            if (Object.keys(currentDefaultPrices).length > 0) {
                for (const key in currentDefaultPrices) {
                    priceListForAI += `- Giá ${currentDefaultPrices[key].name}: ${currentDefaultPrices[key].value.toLocaleString('vi-VN')} VNĐ/m²\n`;
                }
            } else {
                priceListForAI = `
                    - Giá decal: 85,000 VNĐ/m²
                    - Giá in bạt: 70,000 VNĐ/m²
                    - Giá standee: 120,000 VNĐ/m²
                `;
            }

            return `Dạ thưa, tôi là kỹ thuật viên chuyên về máy in Xerox (các dòng C8045, C70, C8035) và chuyên gia in ấn trên mọi loại giấy, bao gồm cả giấy nhựa. Tôi luôn nghiêm túc và chính xác 100% trong mọi phản hồi. Tôi được xây dựng trên nền tảng Gemini, cho phép tôi hỗ trợ đa dạng các yêu cầu của bạn.

                    **CÁC CHỨC NĂNG CHÍNH:**

                    **1. CHUYÊN GIA KỸ THUẬT & IN ẤN (ƯU TIÊN HÀNG ĐẦU):**
                    - Giải đáp mọi thắc mắc về máy in Xerox, các loại giấy, kỹ thuật in ấn.
                    - Tính giá in ấn chính xác khi được yêu cầu. Công thức: (dài * rộng * số lượng) * giá/m². VAT 8% nếu có hóa đơn. Luôn làm tròn và định dạng tiền tệ.
                    - Bảng giá tham khảo:
                    ${priceListForAI.trim()}

                    **2. DỊCH THUẬT SONG NGỮ (CHUYÊN NGÀNH & PHỔ THÔNG):**
                    - Khi người dùng yêu cầu dịch (ví dụ: "dịch 'the soup of the day'"), bạn phải cung cấp hai phiên bản dịch sang Tiếng Việt.
                    - **Định dạng trả lời bắt buộc:**
                      **Chuyên ngành nhà hàng:** [Bản dịch sử dụng thuật ngữ nhà hàng]
                      **Phổ thông:** [Bản dịch thông thường, dễ hiểu]

                    **3. XỬ LÝ HÌNH ẢNH THÔNG MINH:**
                    - **Trích xuất văn bản (OCR):** Nếu người dùng tải ảnh lên mà không có yêu cầu cụ thể, hãy ưu tiên trích xuất toàn bộ văn bản từ ảnh.
                    - **Mô tả hình ảnh:** Nếu được yêu cầu, hãy mô tả chi tiết nội dung của hình ảnh.
                    - **Tạo hình ảnh (Imagen):** Nếu yêu cầu bắt đầu bằng "vẽ", "tạo ảnh", "generate", hãy tạo ra một hình ảnh dựa trên mô tả.

                    **4. TRỢ LÝ ĐA NĂNG (GEMINI):**
                    - **Hỏi đáp & Kiến thức:** Trả lời các câu hỏi về nhiều chủ đề khác nhau.
                    - **Hỗ trợ viết lách:** Soạn thảo email, tóm tắt văn bản, viết nội dung sáng tạo (thơ, truyện ngắn).
                    - **Tư duy & Logic:** Hỗ trợ giải quyết các bài toán logic, toán học.
                    - **Lập trình:** Cung cấp các đoạn mã code đơn giản khi được yêu cầu.

                    **5. THÔNG TIN CÔNG TY (CHỈ KHI ĐƯỢC HỎI):**
                    - **Địa chỉ:** 69 Đào Duy Từ, Hội An.
                    - **Zalo / SĐT:** 0935 000 442.
                    - **Thời gian hiện tại:** ${formattedTime} ngày ${formattedDate} (GMT+7).

                    **QUY TẮC QUAN TRỌNG:**
                    - Luôn ưu tiên trả lời các câu hỏi về kỹ thuật, in ấn, và dịch thuật trước tiên.
                    - Nếu bạn phát hiện tôi có sai sót, vui lòng chỉ ra, tôi sẽ giải thích ngắn gọn và dễ hiểu nhất để bạn nắm rõ vấn đề.
                    - Sau mỗi câu trả lời (trừ dịch thuật, OCR, tạo ảnh), hãy thêm dòng quảng cáo:
                    "---<br>Dạ vâng, quý khách có cần thiết kế hay in ấn chuyên nghiệp tại Hội An không ạ? Hãy liên hệ Công Ty Thiết Kế In Ấn Hội An tại 69 Đào Duy Từ, Zalo/SĐT: 0935 000 442 để được tư vấn và hỗ trợ tốt nhất ạ!"`;
        };

        const getGeminiResponse = async (retryCount = 0) => {
            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) {
                throw new Error("Vui lòng cấu hình API key.");
            }
            if (retryCount >= apiKeys.length) {
                throw new Error("Tất cả API key đều không hoạt động.");
            }
            const apiKey = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = { 
                contents: chatHistory, 
                systemInstruction: { parts: [{ text: generateSystemInstruction() }] } 
            };

            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(`Lỗi API: ${err.error.message}`);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts) {
                    return result.candidates[0].content.parts[0].text;
                }
                if (result.promptFeedback?.blockReason) {
                    return `Yêu cầu bị chặn: ${result.promptFeedback.blockReason}.`;
                }
                throw new Error("Không nhận được phản hồi hợp lệ từ API.");
            } catch (error) {
                console.error(`API key ${currentApiKeyIndex} thất bại:`, error.message);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                return getGeminiResponse(retryCount + 1);
            }
        };

        const getImagenResponse = async (prompt, retryCount = 0) => {
            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) {
                throw new Error("Vui lòng cấu hình API key.");
            }
            if (retryCount >= apiKeys.length) {
                throw new Error("Tất cả API key đều không hoạt động.");
            }
            const apiKey = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(`Lỗi API Imagen: ${err.error?.message || 'Unknown error'}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
                throw new Error("Không nhận được hình ảnh hợp lệ từ API Imagen.");
            } catch (error) {
                console.error(`API key ${currentApiKeyIndex} cho Imagen thất bại:`, error.message);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length; // Cycle to the next key
                return getImagenResponse(prompt, retryCount + 1); // Retry with the next key
            }
        };

        // --- View Control Functions ---
        function showChatView() {
            chatView.classList.remove('hidden');
            adminPanelView.classList.add('hidden');
            if (!mainSidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
            if (!adminSidebar.classList.contains('-translate-x-full')) {
                toggleAdminSidebar();
            }
            console.log("Showing Chat View.");
        }

        function showAdminPanelView() {
            chatView.classList.add('hidden');
            adminPanelView.classList.remove('hidden');
            if (!mainSidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
            showAdminDashboard();
            console.log("Showing Admin Panel View.");
        }
        
        function showAdminDashboard() {
            adminPanelTitle.textContent = 'Bảng Điều Khiển Admin';
            adminDashboard.classList.remove('hidden');
            priceManagementSection.classList.add('hidden');
            defaultPriceDisplaySection.classList.add('hidden');
            salesManagementSection.classList.add('hidden');
        }
        
        function showPriceManagementSection() {
            adminPanelTitle.textContent = 'Quản Lý Giá';
            adminDashboard.classList.add('hidden');
            priceManagementSection.classList.remove('hidden');
            defaultPriceDisplaySection.classList.add('hidden');
            salesManagementSection.classList.add('hidden');
        }

        function showDefaultPriceDisplaySection() {
            adminPanelTitle.textContent = 'Giá Mặc Định';
            adminDashboard.classList.add('hidden');
            priceManagementSection.classList.add('hidden');
            defaultPriceDisplaySection.classList.remove('hidden');
            salesManagementSection.classList.add('hidden');
        }

        function showSalesManagementSection() {
            adminPanelTitle.textContent = 'Bán Hàng';
            adminDashboard.classList.add('hidden');
            priceManagementSection.classList.add('hidden');
            defaultPriceDisplaySection.classList.add('hidden');
            salesManagementSection.classList.remove('hidden');
            resetOrderForm();
        }

        // --- Camera Functions ---
        async function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                cameraFeed.srcObject = null;
                cameraFeed.style.display = 'none';
                startCameraButton.textContent = 'Bật Camera';
                captureSendButton.disabled = true;
                captureSendButton.textContent = 'Chụp Ảnh';
                switchCameraButton.classList.add('hidden'); 
                switchCameraButton.disabled = true;
                mediaStream = null;
                availableVideoDevices = []; 
                currentCameraIndex = -1; 
                showCustomMessage('Camera đã tắt.', 'info');
            }
        }

        async function startCamera(deviceId = null) {
            if (mediaStream) { 
                mediaStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    width: { ideal: 640 }, 
                    height: { ideal: 480 }
                }
            };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            } else {
                constraints.video.facingMode = { exact: 'environment' }; 
            }

            try {
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = mediaStream;
                cameraFeed.style.display = 'block';
                startCameraButton.textContent = 'Tắt Camera';
                captureSendButton.disabled = false;
                captureSendButton.textContent = 'Chụp Ảnh';
                
                await enumerateCameras();
                if (availableVideoDevices.length > 1) {
                    switchCameraButton.classList.remove('hidden');
                    switchCameraButton.disabled = false;
                } else {
                    switchCameraButton.classList.add('hidden');
                    switchCameraButton.disabled = true;
                }

                showCustomMessage('Camera đã bật.', 'info');
            } catch (err) {
                console.error('Lỗi khi truy cập camera:', err);
                if (!deviceId && constraints.video.facingMode && err.name === 'OverconstrainedError') {
                    try {
                        constraints.video.facingMode = { exact: 'user' }; // Try front camera
                        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                        cameraFeed.srcObject = mediaStream;
                        cameraFeed.style.display = 'block';
                        startCameraButton.textContent = 'Tắt Camera';
                        captureSendButton.disabled = false;
                        captureSendButton.textContent = 'Chụp Ảnh';
                        await enumerateCameras(); 
                        if (availableVideoDevices.length > 1) {
                            switchCameraButton.classList.remove('hidden');
                            switchCameraButton.disabled = false;
                        } else {
                            switchCameraButton.classList.add('hidden');
                            switchCameraButton.disabled = true;
                        }
                        showCustomMessage('Camera đã bật (camera trước).', 'info');
                    } catch (userErr) {
                        console.error('Lỗi khi truy cập camera trước:', userErr);
                        showCustomMessage(`Không thể truy cập camera: ${userErr.message}. Vui lòng kiểm tra quyền truy cập.`, 'error');
                        stopCamera(); 
                    }
                } else {
                    showCustomMessage(`Không thể truy cập camera: ${err.message}. Vui lòng kiểm tra quyền truy cập.`, 'error');
                    stopCamera(); 
                }
            }
        }

        async function enumerateCameras() {
            availableVideoDevices = [];
            currentCameraIndex = -1; 
            const devices = await navigator.mediaDevices.enumerateDevices();
            let foundCurrentCamera = false;

            devices.forEach((device) => {
                if (device.kind === 'videoinput') {
                    availableVideoDevices.push(device);
                }
            });
            
            if (mediaStream && mediaStream.getVideoTracks().length > 0) {
                const activeTrack = mediaStream.getVideoTracks()[0];
                const activeDeviceId = activeTrack.getSettings().deviceId;
                const activeLabel = activeTrack.label; 
                let foundIndex = availableVideoDevices.findIndex(dev => dev.deviceId === activeDeviceId);
                if (foundIndex === -1) {
                    foundIndex = availableVideoDevices.findIndex(dev => dev.label === activeLabel);
                }
                if (foundIndex !== -1) {
                    currentCameraIndex = foundIndex;
                    foundCurrentCamera = true;
                }
            }

            if (!foundCurrentCamera && availableVideoDevices.length > 0) {
                currentCameraIndex = 0;
            }
        }

        startCameraButton.addEventListener('click', async () => {
            if (mediaStream && mediaStream.active) {
                stopCamera();
            } else {
                await startCamera(); 
            }
        });

        switchCameraButton.addEventListener('click', async () => {
            if (availableVideoDevices.length > 1) {
                currentCameraIndex = (currentCameraIndex + 1) % availableVideoDevices.length;
                const nextDeviceId = availableVideoDevices[currentCameraIndex].deviceId;
                await startCamera(nextDeviceId);
            } else {
                showCustomMessage('Chỉ có một camera khả dụng.', 'info');
            }
        });

        captureSendButton.addEventListener('click', () => {
            if (mediaStream && mediaStream.active) {
                if (uploadedImages.length >= MAX_IMAGES) {
                    showCustomMessage(`Bạn đã đạt đến giới hạn tối đa ${MAX_IMAGES} ảnh.`);
                    return;
                }
                const context = cameraCanvas.getContext('2d');
                cameraCanvas.width = cameraFeed.videoWidth;
                cameraCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                
                const filename = `captured_${Date.now()}.jpeg`;
                const capturedFile = dataURLtoFile(cameraCanvas.toDataURL('image/jpeg', 0.8), filename);
                
                uploadedImages.push(capturedFile);
                createImagePreview(URL.createObjectURL(capturedFile), capturedFile);
                updateImageCount();
                showCustomMessage('Đã chụp ảnh. Bạn có thể chụp thêm hoặc gửi đi.', 'info');

            } else {
                showCustomMessage('Vui lòng bật camera trước khi chụp ảnh.', 'warning');
            }
        });

        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        // --- UI & Event Handlers ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let message = userInput.value.trim();
            const imagesToSubmit = [...uploadedImages];

            if (!message && imagesToSubmit.length === 0) {
                showCustomMessage("Vui lòng nhập tin nhắn hoặc tải lên ảnh.", "warning");
                return;
            }

            const imageGenKeywords = ['vẽ ', 'tạo ảnh ', 'generate '];
            const imageGenKeyword = imageGenKeywords.find(kw => message.toLowerCase().startsWith(kw));

            if (imageGenKeyword && imagesToSubmit.length === 0) {
                const imagePrompt = message.substring(imageGenKeyword.length);
                appendMessage({ text: message }, 'user');
                userInput.value = '';
                toggleLoading(true);
                showTypingIndicator(true, 'Đang tạo hình ảnh...');

                try {
                    const imageUrl = await getImagenResponse(imagePrompt);
                    appendMessage({ generatedImage: imageUrl, prompt: imagePrompt }, 'bot');
                } catch (error) {
                    appendMessage({ text: `Rất tiếc, tôi không thể tạo ảnh lúc này. Lỗi: ${error.message}` }, 'bot', true);
                } finally {
                    showTypingIndicator(false);
                    toggleLoading(false);
                }

            } else {
                if (imagesToSubmit.length > 0 && !message) {
                    message = "Vui lòng trích xuất toàn bộ văn bản từ (các) hình ảnh này.";
                }

                appendMessage({ text: message, images: imagesToSubmit }, 'user');
                
                userInput.value = '';
                imagePreviewContainer.innerHTML = '';
                uploadedImages = [];
                updateImageCount();
                
                toggleLoading(true);
                showTypingIndicator(true);

                const userPartsForAPI = [];
                if (message) userPartsForAPI.push({ text: message });

                const imageConversionPromises = imagesToSubmit.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            userPartsForAPI.push({
                                inlineData: {
                                    mimeType: file.type,
                                    data: e.target.result.split(',')[1]
                                }
                            });
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                try {
                    await Promise.all(imageConversionPromises);
                    chatHistory.push({ role: "user", parts: userPartsForAPI });
                    const botResponse = await getGeminiResponse();
                    appendMessage({ text: botResponse }, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                } catch (error) {
                    appendMessage({ text: `Lỗi: ${error.message}` }, 'bot', true);
                } finally {
                    showTypingIndicator(false);
                    toggleLoading(false);
                }
            }
        });
        
        let currentCustomMessageCallback = null;

        function showCustomMessage(message, type = 'info', onConfirm = null) {
            customMessageText.textContent = message;
            customMessageModal.classList.remove('hidden');
            
            customMessageOkButton.classList.remove('hidden');
            customMessageCancelButton.classList.add('hidden');

            if (onConfirm) {
                currentCustomMessageCallback = onConfirm;
                customMessageCancelButton.classList.remove('hidden');
            } else {
                currentCustomMessageCallback = null;
            }
        }

        customMessageOkButton.addEventListener('click', () => {
            customMessageModal.classList.add('hidden');
            if (currentCustomMessageCallback) {
                currentCustomMessageCallback();
                currentCustomMessageCallback = null;
            }
        });

        customMessageCancelButton.addEventListener('click', () => {
            customMessageModal.classList.add('hidden');
            currentCustomMessageCallback = null;
        });

        function processFiles(files) {        
            if (!files || files.length === 0) return;        
            const newImageCount = uploadedImages.length + files.length;
            if (newImageCount > MAX_IMAGES) {        
                showCustomMessage(`Chỉ có thể tải lên tối đa ${MAX_IMAGES} ảnh. Bạn đã chọn ${newImageCount} ảnh.`);        
                return;        
            }        
            for (const file of Array.from(files).filter(f => f.type.startsWith('image/'))) {        
                if (uploadedImages.some(img => img.name === file.name && img.size === file.size)) continue;        
                uploadedImages.push(file);        
                createImagePreview(URL.createObjectURL(file), file);        
            }        
            updateImageCount();        
        }
        imageInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        userInput.addEventListener('paste', (e) => { processFiles(e.clipboardData?.files); });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.add('drag-over')));
        ['dragleave', 'drop'].forEach(evt => inputArea.addEventListener(evt, () => inputArea.classList.remove('drag-over')));
        inputArea.addEventListener('drop', (e) => { processFiles(e.dataTransfer?.files); });
        
        function createImagePreview(dataUrl, file) {        
            const pWrap = document.createElement('div');        
            pWrap.className = 'relative';        
            const img = document.createElement('img');        
            img.src = dataUrl;        
            img.className = 'h-16 w-16 object-cover rounded-md shadow-md';        
            pWrap.appendChild(img);        
            const rBtn = document.createElement('button');        
            rBtn.innerHTML = '&times;';        
            rBtn.className = 'absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs shadow-lg';        
            rBtn.onclick = () => {        
                uploadedImages = uploadedImages.filter(item => item !== file);        
                pWrap.remove();        
                updateImageCount();        
            };        
            pWrap.appendChild(rBtn);        
            imagePreviewContainer.appendChild(pWrap);        
        }
        function updateImageCount() {        
            const totalImages = uploadedImages.length;
            imageInfo.textContent = totalImages > 0 ? `Đã chọn ${totalImages}/${MAX_IMAGES} ảnh.` : '';        
        }
        
        function showTypingIndicator(show, customText = '') {
            let indicator = document.getElementById('typing-indicator');
            if (show) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'flex items-center gap-3 mb-6 message-fade-in';
                    indicator.innerHTML = `
                        <div class="avatar-container bg-blue-500">
                            <svg class="text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 4c-2.23 0-4.14 1.25-5.1 3.05A8.93 8.93 0 0 0 4 9c-2.21 0-4 1.79-4 4s1.79 4 4 4h1v2h-1c-3.31 0-6-2.69-6-6 0-2.95 2.14-5.43 5-5.92V4h1c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h1v2h-1c1.55 0 2.96.59 4 1.54V4h1c1.1 0 2 .9 2 2v1c.73.55 1.39 1.22 1.92 2H23v-1c0-2.21-1.79-4-4-4h-4zm-2 5h-2v2H9v2h2v2h2v-2h2v-2h-2V9z"/></svg>
                        </div>
                        <div class="p-4 rounded-2xl shadow-md bg-gray-100 dark:bg-gray-700 rounded-bl-none flex items-center gap-2">
                            <span id="typing-text" class="text-sm mr-2 text-gray-600 dark:text-gray-300"></span>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    `;
                    chatContainer.appendChild(indicator);
                }
                const typingText = indicator.querySelector('#typing-text');
                if (typingText) typingText.textContent = customText;
                indicator.style.display = 'flex';
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                if (indicator) {
                    indicator.remove();
                }
            }
        }

        function appendMessage(data, sender, isError = false) {        
            const { text, images, generatedImage, prompt } = data;        
            const msgWrap = document.createElement('div');        
            msgWrap.className = `flex items-start gap-3 mb-2 ${sender === 'user' ? 'justify-end' : ''}`;        
            
            const msgContainer = document.createElement('div');
            msgContainer.className = `flex flex-col ${sender === 'user' ? 'items-end' : 'items-start'}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar-container';
            
            const msgContent = document.createElement('div');        
            msgContent.className = `p-4 rounded-2xl shadow-md max-w-xs md:max-w-md lg:max-w-xl`;        

            if (sender === 'user') {
                avatar.classList.add('bg-gray-300', 'dark:bg-gray-600');
                avatar.innerHTML = `<svg class="text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                msgContent.classList.add('bg-blue-500', 'text-white', 'rounded-br-none');
            } else {
                avatar.classList.add(isError ? 'bg-red-500' : 'bg-blue-500');
                avatar.innerHTML = isError 
                    ? `<svg class="text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`
                    : `<svg class="text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 4c-2.23 0-4.14 1.25-5.1 3.05A8.93 8.93 0 0 0 4 9c-2.21 0-4 1.79-4 4s1.79 4 4 4h1v2h-1c-3.31 0-6-2.69-6-6 0-2.95 2.14-5.43 5-5.92V4h1c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2h1v2h-1c1.55 0 2.96.59 4 1.54V4h1c1.1 0 2 .9 2 2v1c.73.55 1.39 1.22 1.92 2H23v-1c0-2.21-1.79-4-4-4h-4zm-2 5h-2v2H9v2h2v2h2v-2h2v-2h-2V9z"/></svg>`;
                
                if (isError) {
                    msgContent.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-800', 'dark:text-red-200', 'rounded-bl-none');
                } else {
                    msgContent.classList.add('bg-gray-100', 'dark:bg-gray-700', 'rounded-bl-none');
                }
            }
            
            if (generatedImage) {
                const genImgContainer = document.createElement('div');
                genImgContainer.className = 'mt-2';
                const img = document.createElement('img');
                img.src = generatedImage;
                img.alt = prompt || 'Generated Image';
                img.className = 'w-full max-w-xs h-auto object-cover rounded-lg shadow-md';
                genImgContainer.appendChild(img);
                msgContent.appendChild(genImgContainer);
            }

            if (images?.length) {        
                const grid = document.createElement('div');        
                grid.className = `grid grid-cols-2 sm:grid-cols-3 gap-2 rounded-lg overflow-hidden ${generatedImage ? 'mt-3' : ''}`;        
                images.forEach(imgData => {        
                    const img = document.createElement('img');        
                    img.src = URL.createObjectURL(imgData);
                    img.className = 'w-full h-auto object-cover rounded-md aspect-square';        
                    img.onload = () => URL.revokeObjectURL(img.src);
                    grid.appendChild(img);        
                });        
                msgContent.appendChild(grid);        
            }        
            
            if (text) {        
                const p = document.createElement('p');        
                p.className = `text-sm leading-relaxed ${(images?.length || generatedImage) ? 'mt-3' : ''}`;        
                p.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');        
                msgContent.appendChild(p);        
            }        
            
            const time = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const timeEl = document.createElement('div');
            timeEl.className = `text-xs mt-2 ${sender === 'user' ? 'text-blue-200' : 'text-gray-400'}`;
            timeEl.textContent = time;

            msgContainer.appendChild(msgContent);
            msgContainer.appendChild(timeEl);

            if (sender === 'user') {        
                msgWrap.append(msgContainer, avatar);        
            } else {        
                msgWrap.append(avatar, msgContainer);        
            }        
            
            const fullMessageWrapper = document.createElement('div');
            fullMessageWrapper.className = 'message-fade-in w-full';
            fullMessageWrapper.appendChild(msgWrap);
            chatContainer.appendChild(fullMessageWrapper);        
            chatContainer.scrollTop = chatContainer.scrollHeight;        
        }

        function toggleLoading(isLoading) {        
            sendButton.disabled = isLoading;        
            userInput.disabled = isLoading;        
            document.getElementById('image-upload-button').style.pointerEvents = isLoading ? 'none' : 'auto';        
            
            sendIcon.classList.toggle('hidden', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);        

            if (isMobileDevice()) {
                startCameraButton.disabled = isLoading;        
                captureSendButton.disabled = isLoading || !mediaStream || !mediaStream.active;        
                switchCameraButton.disabled = isLoading || availableVideoDevices.length <= 1;        
            }

            if (!isLoading) userInput.focus();        
        }

        // --- Admin Login Logic ---
        adminLoginButton.addEventListener('click', () => {
            adminLoginModal.classList.remove('hidden');
            adminUsernameInput.value = 'admin';
            adminPasswordInput.value = 'admin';
            adminLoginError.classList.add('hidden');
            adminUsernameInput.focus();
        });

        cancelAdminLoginButton.addEventListener('click', () => {
            adminLoginModal.classList.add('hidden');
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = adminUsernameInput.value;
            const password = adminPasswordInput.value;
            adminLoginError.classList.add('hidden');

            try {
                const adminDoc = await getDoc(adminSettingsDocRef);
                if (adminDoc.exists()) {
                    const adminData = adminDoc.data();
                    if (adminData.username === username && adminData.password === password) {
                        isAdminLoggedIn = true;
                        adminLoginModal.classList.add('hidden');
                        showCustomMessage('Đăng nhập Admin thành công!', 'success');
                        showAdminPanelView();
                        console.log("Admin logged in!");
                    } else {
                        adminLoginError.classList.remove('hidden');
                    }
                } else {
                    adminLoginError.textContent = 'Không tìm thấy thông tin admin. Vui lòng thử lại.';
                    adminLoginError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Lỗi khi đăng nhập admin:", error);
                adminLoginError.textContent = `Lỗi hệ thống: ${error.message}`;
                adminLoginError.classList.remove('hidden');
            }
        });

        // --- Admin Panel Button Handlers ---
        const showUnderDevelopmentMessage = () => {
            showCustomMessage('Chức năng đang trong giai đoạn phát triển và sẽ hoạt động sớm nhất.', 'info');
        };

        priceManagementButton.addEventListener('click', showPriceManagementSection);
        salesManagementButton.addEventListener('click', showSalesManagementSection);
        defaultPriceButton.addEventListener('click', showDefaultPriceDisplaySection);
        customPriceButton.addEventListener('click', showUnderDevelopmentMessage);
        backToAdminDashboardButton.addEventListener('click', showAdminDashboard);
        quotationManagementButton.addEventListener('click', showUnderDevelopmentMessage);
        debtManagementButton.addEventListener('click', showUnderDevelopmentMessage);

        logoutButton.addEventListener('click', () => {
            isAdminLoggedIn = false;
            showChatView();
            showCustomMessage('Đã đăng xuất khỏi Admin Panel.', 'info');
            console.log("Admin logged out!");
        });

        backToChatButton.addEventListener('click', () => {
            showChatView();
        });

        backToPriceManagementButton.addEventListener('click', showPriceManagementSection);
        backToAdminDashboardFromSalesButton.addEventListener('click', showAdminDashboard);


        // --- Price Management Logic (CRUD) ---
        function renderDefaultPrices(prices) {
            priceListContainer.innerHTML = '';
            if (prices.length === 0) {
                noPricesMessage.classList.remove('hidden');
                priceListContainer.appendChild(noPricesMessage);
            } else {
                noPricesMessage.classList.add('hidden');
                prices.forEach(price => {
                    const priceItem = document.createElement('div');
                    priceItem.className = 'flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm';
                    priceItem.innerHTML = `
                        <div>
                            <strong class="text-gray-800 dark:text-gray-100">${price.name}:</strong> 
                            <span class="text-gray-700 dark:text-gray-200">${price.value.toLocaleString('vi-VN')} VNĐ/m²</span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${price.id}" data-name="${price.name}" data-value="${price.value}" class="edit-price-button bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            </button>
                            <button data-id="${price.id}" class="delete-price-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-full text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    `;
                    priceListContainer.appendChild(priceItem);
                });

                document.querySelectorAll('.edit-price-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const { id, name, value } = e.currentTarget.dataset;
                        openPriceForm(id, name, parseFloat(value));
                    });
                });

                document.querySelectorAll('.delete-price-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        deleteDefaultPrice(e.currentTarget.dataset.id);
                    });
                });
            }
        }

        function openPriceForm(id = '', name = '', value = '') {
            priceFormModal.classList.remove('hidden');
            priceIdInput.value = id;
            priceNameInput.value = name;
            priceValueInput.value = value;
            priceFormTitle.textContent = id ? 'Sửa Giá Vật Liệu' : 'Thêm Giá Vật Liệu Mới';
            savePriceButton.textContent = id ? 'Cập Nhật' : 'Lưu';
        }

        cancelPriceButton.addEventListener('click', () => {
            priceFormModal.classList.add('hidden');
            priceForm.reset();
        });

        addNewPriceButton.addEventListener('click', () => openPriceForm());

        priceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = priceIdInput.value;
            const name = priceNameInput.value.trim();
            const value = parseFloat(priceValueInput.value);

            if (!name || isNaN(value) || value < 0) {
                showCustomMessage('Vui lòng nhập tên mục và giá trị hợp lệ.', 'warning');
                return;
            }

            try {
                if (id) {
                    await updateDoc(doc(defaultPricesCollectionRef, id), { name, value });
                    showCustomMessage('Giá đã được cập nhật thành công!', 'success');
                } else {
                    await addDoc(defaultPricesCollectionRef, { name, value });
                    showCustomMessage('Giá mới đã được thêm thành công!', 'success');
                }
                priceFormModal.classList.add('hidden');
                priceForm.reset();
            } catch (error) {
                console.error("Lỗi khi lưu giá:", error);
                showCustomMessage(`Lỗi khi lưu giá: ${error.message}`, 'error');
            }
        });

        async function deleteDefaultPrice(id) {
            showCustomMessage('Bạn có chắc chắn muốn xóa mục giá này không?', 'confirm', async () => {
                try {
                    await deleteDoc(doc(defaultPricesCollectionRef, id));
                    showCustomMessage('Mục giá đã được xóa thành công!', 'success');
                } catch (error) {
                    console.error("Lỗi khi xóa giá:", error);
                    showCustomMessage(`Lỗi khi xóa giá: ${error.message}`, 'error');
                }
            });
        }
        
        // --- Sales Management Logic ---
        function resetOrderForm() {
            currentOrder = { items: [], totalAmount: 0, deposit: 0, remainingAmount: 0 };
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            orderDepositInput.value = 0;
            renderOrderItems();
            updateOrderTotals();
        }

        function updateOrderTotals() {
            const totalAmount = currentOrder.items.reduce((sum, item) => sum + item.total, 0);
            const deposit = parseFloat(orderDepositInput.value) || 0;
            const remainingAmount = totalAmount - deposit;
            
            currentOrder.totalAmount = totalAmount;
            currentOrder.deposit = deposit;
            currentOrder.remainingAmount = remainingAmount;

            orderTotalSpan.textContent = formatCurrency(totalAmount);
            orderRemainingSpan.textContent = formatCurrency(remainingAmount);
        }

        function renderOrderItems() {
            currentOrderItemsContainer.innerHTML = '';
            if (currentOrder.items.length === 0) {
                currentOrderItemsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có mục nào.</p>';
            } else {
                currentOrder.items.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded-md text-sm';
                    itemEl.innerHTML = `
                        <span class="font-medium">${item.name} (${item.quantity}x, ${item.width || '-'}m x ${item.height || '-'}m)</span>
                        <div class="flex items-center gap-4">
                             <span class="font-semibold text-blue-600 dark:text-blue-400">${formatCurrency(item.total)}</span>
                             <button data-index="${index}" class="remove-order-item-button text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `;
                    currentOrderItemsContainer.appendChild(itemEl);
                });

                document.querySelectorAll('.remove-order-item-button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index, 10);
                        currentOrder.items.splice(index, 1);
                        renderOrderItems();
                        updateOrderTotals();
                    });
                });
            }
        }
        
        function populateDefaultItemsDatalist(prices) {
            defaultItemsDatalist.innerHTML = '';
            Object.values(prices).forEach(price => {
                const option = document.createElement('option');
                option.value = price.name;
                defaultItemsDatalist.appendChild(option);
            });
        }

        itemNameInput.addEventListener('change', () => {
            const selectedName = itemNameInput.value.toLowerCase();
            const priceData = currentDefaultPrices[selectedName];
            if (priceData) {
                itemPriceInput.value = priceData.value;
            }
        });

        addOrderItemButton.addEventListener('click', () => {
            const name = itemNameInput.value.trim();
            const width = parseFloat(itemWidthInput.value) || 0;
            const height = parseFloat(itemHeightInput.value) || 0;
            const quantity = parseInt(itemQuantityInput.value, 10) || 1;
            const pricePerUnit = parseFloat(itemPriceInput.value) || 0;

            if (!name || quantity <= 0 || pricePerUnit <= 0) {
                showCustomMessage('Vui lòng nhập tên, số lượng và đơn giá hợp lệ.', 'warning');
                return;
            }

            let total;
            if (width > 0 && height > 0) {
                total = width * height * quantity * pricePerUnit;
            } else {
                total = quantity * pricePerUnit;
            }

            currentOrder.items.push({ name, width, height, quantity, pricePerUnit, total });
            renderOrderItems();
            updateOrderTotals();
            
            // Clear item input fields
            itemNameInput.value = '';
            itemWidthInput.value = '';
            itemHeightInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
        });

        orderDepositInput.addEventListener('input', updateOrderTotals);
        clearOrderButton.addEventListener('click', () => {
             showCustomMessage('Bạn có chắc muốn xóa toàn bộ đơn hàng hiện tại không?', 'confirm', () => {
                resetOrderForm();
                showCustomMessage('Đơn hàng đã được xóa.', 'info');
            });
        });

        saveOrderButton.addEventListener('click', async () => {
            const customerName = customerNameInput.value.trim();
            if (!customerName) {
                showCustomMessage('Vui lòng nhập tên khách hàng.', 'warning');
                return;
            }
            if (currentOrder.items.length === 0) {
                showCustomMessage('Vui lòng thêm ít nhất một mục vào đơn hàng.', 'warning');
                return;
            }

            const finalOrder = {
                ...currentOrder,
                customerName: customerName,
                customerPhone: customerPhoneInput.value.trim(),
                createdAt: serverTimestamp(),
                status: 'pending'
            };

            try {
                await addDoc(salesOrdersCollectionRef, finalOrder);
                showCustomMessage('Đơn hàng đã được lưu thành công!', 'success');
                resetOrderForm();
            } catch (error) {
                 console.error("Lỗi khi lưu đơn hàng:", error);
                 showCustomMessage(`Lỗi khi lưu đơn hàng: ${error.message}`, 'error');
            }
        });
        
        function renderRecentOrders(orders) {
            recentOrdersListContainer.innerHTML = '';
            if (orders.length === 0) {
                recentOrdersListContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có đơn hàng nào.</p>';
                return;
            }
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm';
                const orderDate = order.createdAt?.toDate().toLocaleString('vi-VN') || 'N/A';
                
                orderCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                         <h4 class="font-bold text-lg">${order.customerName}</h4>
                         <span class="text-sm text-gray-500 dark:text-gray-400">${orderDate}</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300">SĐT: ${order.customerPhone || 'N/A'}</p>
                    <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600 text-right">
                        <p>Tổng cộng: <span class="font-semibold">${formatCurrency(order.totalAmount)}</span></p>
                        <p>Còn lại: <span class="font-bold text-green-600">${formatCurrency(order.remainingAmount)}</span></p>
                    </div>
                `;
                recentOrdersListContainer.appendChild(orderCard);
            });
        }

        // --- Sidebar Toggle Logic ---
        function toggleSidebar() {
            mainSidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }
        menuButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        function toggleAdminSidebar() {
            adminSidebar.classList.toggle('-translate-x-full');
            adminSidebarOverlay.classList.toggle('hidden');
        }
        adminMenuButton.addEventListener('click', toggleAdminSidebar);
        adminSidebarOverlay.addEventListener('click', toggleAdminSidebar);


        // --- App Initialization ---
        const main = async () => {
            if (!isMobileDevice()) {
                cameraControls.style.display = 'none';
            }

            appendMessage({ text: "Dạ thưa, tôi là kỹ thuật viên chuyên về máy in Xerox (các dòng C8045, C70, C8035) và chuyên gia in ấn trên mọi loại giấy, bao gồm cả giấy nhựa. Tôi có thể hỗ trợ bạn về dịch thuật, trích xuất văn bản, thiết kế ảnh, hoặc tính giá in ấn. Tôi có thể giúp gì cho bạn hôm nay ạ?" }, 'bot');
            try {
                const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
                
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.warn("Firebase config is incomplete. Firestore features will be disabled.");
                } else {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app); 
                    db = getFirestore(app);

                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    defaultPricesCollectionRef = collection(db, `artifacts/${appId}/public/data/defaultPrices`);
                    adminSettingsDocRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'mainAdmin');
                    salesOrdersCollectionRef = collection(db, `artifacts/${appId}/public/data/salesOrders`);

                    onAuthStateChanged(auth, async user => {
                        userId = user?.uid;
                        isAuthReady = !!user;
                        if (isAuthReady) {
                            console.log("Firebase Auth sẵn sàng. User ID:", userId);

                            const adminDocSnapshot = await getDoc(adminSettingsDocRef);
                            if (!adminDocSnapshot.exists()) {
                                await setDoc(adminSettingsDocRef, {
                                    username: 'admin',
                                    password: 'admin'
                                });
                                console.log("Default admin credentials created in Firestore.");
                            }

                            const initialPrices = [
                                { name: "decal", value: 85000 },
                                { name: "in bạt", value: 70000 },
                                { name: "standee", value: 120000 }
                            ];
                            for (const price of initialPrices) {
                                const q = query(defaultPricesCollectionRef, where("name", "==", price.name));
                                const querySnapshot = await getDocs(q);
                                if (querySnapshot.empty) {
                                    await addDoc(defaultPricesCollectionRef, price);
                                    console.log(`Added initial price for ${price.name}`);
                                }
                            }

                            onSnapshot(defaultPricesCollectionRef, (snapshot) => {
                                const prices = [];
                                const pricesMap = {};
                                snapshot.forEach(doc => {
                                    const data = doc.data();
                                    prices.push({ id: doc.id, ...data });
                                    pricesMap[data.name.toLowerCase()] = { id: doc.id, ...data };
                                });
                                currentDefaultPrices = pricesMap;
                                renderDefaultPrices(prices);
                                populateDefaultItemsDatalist(pricesMap);
                            }, (error) => console.error("Lỗi khi tải giá mặc định:", error));
                            
                            // Listener for recent sales orders
                            onSnapshot(salesOrdersCollectionRef, (snapshot) => {
                                let orders = [];
                                snapshot.forEach(doc => {
                                    orders.push({ id: doc.id, ...doc.data() });
                                });
                                // Sort by date client-side as per instructions
                                orders.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                                renderRecentOrders(orders.slice(0, 10)); // Display latest 10
                            }, (error) => console.error("Lỗi khi tải đơn hàng:", error));
                        }
                    });

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Signed in with custom token.");
                        } catch (tokenError) {
                            console.warn("Custom token sign-in failed, attempting anonymous sign-in:", tokenError);
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously as fallback.");
                        }
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                }
            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                appendMessage({ text: `Lỗi: Không thể kết nối đến dịch vụ Firebase. (${error.message})` }, 'bot', true);
            }

            showChatView();
        };

        main();
    </script>
</body>
</html>

