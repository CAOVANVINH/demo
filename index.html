<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Ty Thiết Kế In Ấn Hội An - Quản Lý Công Việc</title>
    <!-- Tích hợp Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Font tùy chỉnh */
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;800&display=swap');
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        /* Hiệu ứng chữ chạy màu gradient */
        .animated-gradient-text {
            background: linear-gradient(to right, #3b82f6, #8b5cf6, #ec4899, #f59e0b, #3b82f6);
            background-size: 250% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 5s linear infinite;
        }

        @keyframes gradient-animation {
            to {
                background-position: 250% center;
            }
        }
        /* Hiệu ứng khi gạch ngang công việc */
        .completed .task-content,
        .completed .customer-info {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* Style cho date time picker để dễ nhìn hơn trong dark mode */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }
        .dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        /* Ẩn các mục không cần thiết */
        .hidden {
            display: none !important;
        }
        /* Hiệu ứng cho modal */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 200ms, transform 200ms;
        }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
        }
        .modal-leave {
            opacity: 1;
            transform: scale(1);
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
        }
        /* Style cho loading spinner */
        #loading-overlay {
            z-index: 100;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center">
        <div class="spinner w-16 h-16 border-8 border-gray-300 rounded-full"></div>
        <p class="text-white text-lg mt-4">Đang tải dữ liệu...</p>
    </div>

    <!-- Modal Thêm/Sửa Công Việc -->
    <div id="taskModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="modalContent" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl relative">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl" aria-label="Đóng">&times;</button>
            <div class="p-6 sm:p-8">
                <h3 id="modalTitle" class="text-2xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">Thêm Công Việc Mới</h3>
                <input type="hidden" id="taskEditId" value="">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="customerNameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tên khách hàng <span class="text-red-500">*</span></label>
                        <input type="text" id="customerNameInput" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700" placeholder="Nguyễn Văn A">
                    </div>
                    <div>
                        <label for="phoneInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Số điện thoại</label>
                        <input type="tel" id="phoneInput" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700" placeholder="(Không bắt buộc)">
                    </div>
                    <div>
                        <label for="addressInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Địa chỉ</label>
                        <input type="text" id="addressInput" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700" placeholder="(Không bắt buộc)">
                    </div>
                    <div>
                        <label for="timeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Thời gian <span class="text-red-500">*</span></label>
                        <input type="datetime-local" id="timeInput" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                    </div>
                </div>
                <div class="mb-6">
                    <label for="taskInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nội dung công việc <span class="text-red-500">*</span></label>
                    <textarea id="taskInput" rows="3" class="w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700" placeholder="Sửa chữa máy lạnh, thay gas..."></textarea>
                </div>
                <button id="submitTaskBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md flex items-center justify-center gap-2">
                    <i id="submitIcon" class="fas fa-plus"></i>
                    <span id="submitText">Thêm Công Việc</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Đăng nhập Admin -->
    <div id="adminModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="adminModalContent" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm relative">
            <button id="closeAdminModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl" aria-label="Đóng">&times;</button>
            <div class="p-8">
                <h3 class="text-2xl font-bold mb-6 text-center text-purple-600 dark:text-purple-400">Đăng Nhập Admin</h3>
                <div class="space-y-4">
                    <div>
                        <label for="usernameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tên người dùng</label>
                        <input type="text" id="usernameInput" class="mt-1 w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700">
                    </div>
                    <div>
                        <label for="passwordInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mật khẩu</label>
                        <input type="password" id="passwordInput" class="mt-1 w-full p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:bg-gray-700">
                    </div>
                </div>
                 <p id="loginError" class="text-red-500 text-sm mt-2 text-center hidden">Sai thông tin đăng nhập!</p>
                <button id="loginBtn" class="mt-6 w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">Đăng Nhập</button>
            </div>
        </div>
    </div>


    <!-- Nội dung chính của trang -->
    <div class="container mx-auto max-w-7xl mt-8 sm:mt-16 px-4 pb-20">
        
        <div class="text-center mb-6">
            <h1 class="animated-gradient-text text-3xl sm:text-4xl md:text-5xl font-extrabold pb-2">Công Ty Thiết Kế In Ấn Hội An</h1>
        </div>

        <header class="text-center mb-8">
            <h2 class="text-2xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">Quản Lý Công Việc</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Nơi quản lý tất cả công việc của bạn.</p>
        </header>

        <div class="mb-8 text-center">
             <button id="openModalBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105 flex items-center justify-center gap-2 mx-auto">
                <i class="fas fa-plus-circle"></i>
                <span>Tạo Công Việc Mới</span>
            </button>
        </div>
        
        <!-- Hiển thị User ID -->
        <div id="userInfo" class="text-center mb-6 hidden">
            <p class="text-xs text-gray-500 dark:text-gray-400">Mã phiên làm việc (User ID): <span id="userIdDisplay" class="font-mono bg-gray-200 dark:bg-gray-700 p-1 rounded"></span></p>
        </div>

        <!-- Khu vực Admin Controls -->
        <div id="adminControls" class="hidden my-6 p-4 bg-purple-100 dark:bg-purple-900/30 border border-purple-300 dark:border-purple-700 rounded-lg">
            <h3 class="text-lg font-bold text-purple-800 dark:text-purple-300 mb-3 text-center">Bảng điều khiển Admin</h3>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button id="backupBtn" class="flex-1 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2"><i class="fas fa-download"></i> Sao lưu</button>
                <button id="restoreBtn" class="flex-1 bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2"><i class="fas fa-upload"></i> Phục hồi</button>
                <button id="logoutBtn" class="flex-1 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center gap-2"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
                <input type="file" id="restoreFileInput" class="hidden" accept=".json">
            </div>
        </div>

        <!-- Danh sách công việc -->
        <div class="bg-transparent dark:bg-transparent rounded-lg p-0">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 pb-4 border-b-2 border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold mb-2 sm:mb-0">Danh Sách Công Việc</h3>
                <div class="flex items-center space-x-3">
                    <label for="hideCompletedToggle" class="text-sm font-medium text-gray-600 dark:text-gray-300 select-none">Ẩn việc đã xong</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="hideCompletedToggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
            <ul id="taskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></ul>
            <div id="no-tasks-message" class="text-center text-gray-500 dark:text-gray-400 py-10 hidden">
                <i class="fas fa-check-circle fa-3x mb-3 text-green-500"></i>
                <p class="text-lg">Tuyệt vời! Không có công việc nào cần làm.</p>
            </div>
        </div>
        
        <footer class="text-center mt-10 text-gray-500 dark:text-gray-400 text-sm">
            <p>Tạo bởi Gemini với ❤️</p>
        </footer>
    </div>
    
    <!-- Nút Admin nổi -->
    <button id="openAdminModalBtn" class="fixed bottom-4 right-4 bg-purple-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-purple-700 transition-transform transform hover:scale-110 z-40">
        <i class="fas fa-user-shield text-2xl"></i>
    </button>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import các hàm cần thiết từ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, writeBatch, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STATE & CONSTANTS ---
        let allTasks = []; // Local cache of tasks
        let db, auth; // Firebase services
        let userId; // Current user's ID
        let tasksUnsubscribe = null; // Function to stop listening for task updates
        // THAY ĐỔI: Lấy App ID một cách an toàn
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const customerNameInput = document.getElementById('customerNameInput');
        const phoneInput = document.getElementById('phoneInput');
        const addressInput = document.getElementById('addressInput');
        const timeInput = document.getElementById('timeInput');
        const taskInput = document.getElementById('taskInput');
        const submitTaskBtn = document.getElementById('submitTaskBtn');
        const modalTitle = document.getElementById('modalTitle');
        const submitIcon = document.getElementById('submitIcon');
        const submitText = document.getElementById('submitText');
        const taskEditId = document.getElementById('taskEditId');

        const taskList = document.getElementById('taskList');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const hideCompletedToggle = document.getElementById('hideCompletedToggle');
        
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('modalContent');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');

        const adminModal = document.getElementById('adminModal');
        const adminModalContent = document.getElementById('adminModalContent');
        const openAdminModalBtn = document.getElementById('openAdminModalBtn');
        const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');
        const usernameInput = document.getElementById('usernameInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        const adminControls = document.getElementById('adminControls');
        const backupBtn = document.getElementById('backupBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const restoreFileInput = document.getElementById('restoreFileInput');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const userInfo = document.getElementById('userInfo');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- MODAL HELPER ---
        function setupModal(modal, openBtn, closeBtn, content, onCloseCallback) {
            function show() {
                modal.classList.remove('hidden');
                content.classList.remove('modal-leave-active');
                content.classList.add('modal-enter-active');
            }
            function hide() {
                content.classList.add('modal-leave-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    content.classList.remove('modal-leave-active');
                    if(onCloseCallback) onCloseCallback();
                }, 200);
            }
            if (openBtn) openBtn.addEventListener('click', show);
            if (closeBtn) closeBtn.addEventListener('click', hide);
            modal.addEventListener('click', (e) => { if (e.target === modal) hide(); });
            return { show, hide };
        }
        
        function resetTaskModal() {
            modalTitle.textContent = 'Thêm Công Việc Mới';
            submitText.textContent = 'Thêm Công Việc';
            submitIcon.className = 'fas fa-plus';
            taskEditId.value = '';
            
            customerNameInput.value = '';
            phoneInput.value = '';
            addressInput.value = '';
            timeInput.value = '';
            taskInput.value = '';
        }

        const taskModalControls = setupModal(taskModal, openModalBtn, closeModalBtn, modalContent, resetTaskModal);
        const adminModalControls = setupModal(adminModal, openAdminModalBtn, closeAdminModalBtn, adminModalContent);

        // --- ADMIN LOGIC ---
        function handleAdminLogin() {
            if (usernameInput.value === 'admin' && passwordInput.value === 'admin') {
                adminControls.classList.remove('hidden');
                openAdminModalBtn.classList.add('hidden');
                adminModalControls.hide();
                loginError.classList.add('hidden');
                usernameInput.value = '';
                passwordInput.value = '';
            } else {
                loginError.classList.remove('hidden');
            }
        }
        function handleAdminLogout() {
            adminControls.classList.add('hidden');
            openAdminModalBtn.classList.remove('hidden');
        }
        
        // --- BACKUP & RESTORE LOGIC ---
        function backupTasks() {
            if (allTasks.length === 0) {
                alert('Không có công việc nào để sao lưu.');
                return;
            }
            const dataStr = JSON.stringify(allTasks, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            document.body.appendChild(a);
a.style.display = 'none';
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `sao-luu-cong-viec-${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function handleFileRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('Bạn có chắc chắn muốn phục hồi? Hành động này sẽ XÓA TOÀN BỘ công việc hiện tại trên đám mây và thay thế bằng dữ liệu từ tệp này.')) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    loadingOverlay.classList.remove('hidden');
                    const restoredTasks = JSON.parse(e.target.result);
                    if (!Array.isArray(restoredTasks)) throw new Error('Tệp không hợp lệ.');
                    
                    const batchDelete = writeBatch(db);
                    allTasks.forEach(task => {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, task.id);
                        batchDelete.delete(docRef);
                    });
                    await batchDelete.commit();

                    const batchAdd = writeBatch(db);
                    restoredTasks.forEach(task => {
                        const newDocRef = doc(collection(db, `artifacts/${appId}/users/${userId}/tasks`));
                        const { id, ...taskData } = task; 
                        batchAdd.set(newDocRef, taskData);
                    });
                    await batchAdd.commit();

                    alert('Phục hồi thành công!');
                } catch (err) {
                    console.error("Lỗi phục hồi:", err);
                    alert('Lỗi: Không thể đọc tệp sao lưu. Tệp có thể bị hỏng hoặc không đúng định dạng.');
                } finally {
                    loadingOverlay.classList.add('hidden');
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --- CORE RENDER LOGIC ---
        function renderAllTasks() {
            const sortedTasks = [...allTasks].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1;
                }
                const timeA = a.createdAt?.toDate() || 0;
                const timeB = b.createdAt?.toDate() || 0;
                return timeB - timeA;
            });

            taskList.innerHTML = '';
            sortedTasks.forEach(taskData => {
                const { id, customerName, phone, address, time, text, completed } = taskData;
                
                const li = document.createElement('li');
                li.className = `bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col justify-between transition-all duration-300 hover:shadow-xl hover:-translate-y-1 ${completed ? 'completed opacity-60' : ''}`;
                
                const completeBtnText = completed ? 'Làm lại' : 'Hoàn thành';
                const completeBtnClass = completed ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';

                li.innerHTML = `
                    <div> 
                        <p class="font-bold text-lg task-content mb-3 break-words">${text}</p>
                        <div class="customer-info text-sm text-gray-600 dark:text-gray-400 space-y-2">
                            <div class="flex items-center"><i class="fas fa-user fa-fw mr-2 text-blue-500"></i><span class="customer-name truncate" title="${customerName}">${customerName}</span></div>
                            <div class="flex items-center"><i class="fas fa-clock fa-fw mr-2 text-orange-500"></i><span class="task-time truncate">${new Date(time).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span></div>
                            ${phone ? `<div class="flex items-center"><i class="fas fa-phone fa-fw mr-2 text-green-500"></i><span class="customer-phone truncate" title="${phone}">${phone}</span></div>` : ''}
                            ${address ? `<div class="flex items-center"><i class="fas fa-map-marker-alt fa-fw mr-2 text-purple-500"></i><span class="customer-address" title="${address}">${address}</span></div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <button data-action="toggle" data-id="${id}" class="font-semibold py-1.5 px-3 rounded-lg text-xs text-white transition-colors duration-200 ${completeBtnClass}">
                            ${completeBtnText}
                        </button>
                        <div class="flex space-x-2">
                            <button data-action="edit" data-id="${id}" class="flex items-center justify-center bg-blue-500 text-white hover:bg-blue-600 w-8 h-8 rounded-full text-sm transition-colors duration-200" aria-label="Sửa"><i class="fas fa-pencil-alt"></i></button>
                            <button data-action="delete" data-id="${id}" class="flex items-center justify-center bg-red-500 text-white hover:bg-red-600 w-8 h-8 rounded-full text-sm transition-colors duration-200" aria-label="Xóa"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                taskList.appendChild(li);
            });
            updateCompletedTasksVisibility();
        }
        
        // --- UI UTILITY FUNCTIONS ---
        function checkEmptyState() {
            const hasVisibleTasks = Array.from(taskList.children).some(task => !task.classList.contains('hidden'));
            noTasksMessage.classList.toggle('hidden', !(allTasks.length === 0 || !hasVisibleTasks));
        }

        function updateCompletedTasksVisibility() {
            const shouldHide = hideCompletedToggle.checked;
            taskList.querySelectorAll('li').forEach(li => {
                const isCompleted = li.classList.contains('completed');
                li.classList.toggle('hidden', shouldHide && isCompleted);
            });
            checkEmptyState();
        }

        // --- EVENT HANDLERS (FIRESTORE) ---
        async function handleTaskListClick(event) {
            const button = event.target.closest('button[data-action]');
            if (!button) return;

            const taskId = button.dataset.id;
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            const action = button.dataset.action;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);

            if (action === 'toggle') {
                try {
                    await setDoc(docRef, { completed: !task.completed }, { merge: true });
                } catch (e) {
                    console.error("Lỗi cập nhật công việc: ", e);
                    alert("Đã xảy ra lỗi khi cập nhật trạng thái công việc.");
                }
            }

            if (action === 'delete') {
                if (confirm(`Bạn có chắc muốn xóa công việc của "${task.customerName}"?`)) {
                    try {
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Lỗi xóa công việc: ", e);
                        alert("Đã xảy ra lỗi khi xóa công việc.");
                    }
                }
            }
            
            if (action === 'edit') {
                openEditModal(taskId);
            }
        }

        function openEditModal(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            modalTitle.textContent = 'Chỉnh Sửa Công Việc';
            submitText.textContent = 'Lưu Thay Đổi';
            submitIcon.className = 'fas fa-save';

            customerNameInput.value = task.customerName;
            phoneInput.value = task.phone;
            addressInput.value = task.address;
            taskInput.value = task.text;
            
            const date = new Date(task.time);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            timeInput.value = date.toISOString().slice(0, 16);
            
            taskEditId.value = taskId;
            taskModalControls.show();
        }

        async function handleSubmitTask() {
            const taskData = {
                customerName: customerNameInput.value.trim(),
                phone: phoneInput.value.trim(),
                address: addressInput.value.trim(),
                time: timeInput.value,
                text: taskInput.value.trim(),
            };

            if (!taskData.customerName || !taskData.time || !taskData.text) {
                alert('Vui lòng nhập các trường bắt buộc: Tên khách hàng, Thời gian và Nội dung công việc!');
                return;
            }

            const editId = taskEditId.value;
            submitTaskBtn.disabled = true;

            try {
                if (editId) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, editId);
                    await setDoc(docRef, taskData, { merge: true });
                } else {
                    taskData.completed = false;
                    taskData.createdAt = serverTimestamp();
                    const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                    await addDoc(collectionRef, taskData);
                }
                taskModalControls.hide();
            } catch (e) {
                console.error("Lỗi lưu công việc:", e);
                alert("Đã xảy ra lỗi khi lưu công việc vào đám mây.");
            } finally {
                submitTaskBtn.disabled = false;
            }
        }
        
        // --- FIREBASE INITIALIZATION ---
        // THAY ĐỔI: Hàm khởi tạo an toàn hơn
        function initializeFirebase() {
            if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                console.error("Lỗi: Cấu hình Firebase không tồn tại.");
                loadingOverlay.innerHTML = '<p class="text-red-500 text-lg text-center px-4">Lỗi cấu hình máy chủ.<br>Vui lòng đảm bảo ứng dụng được chạy trong môi trường hợp lệ.</p>';
                return;
            }
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                handleAuthentication();
            } catch (e) {
                console.error("Lỗi khởi tạo Firebase:", e);
                loadingOverlay.innerHTML = '<p class="text-red-500 text-lg">Lỗi kết nối đến máy chủ. Vui lòng tải lại trang.</p>';
            }
        }

        async function handleAuthentication() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500 text-lg">Lỗi xác thực người dùng.</p>';
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    userInfo.classList.remove('hidden');
                    
                    if (tasksUnsubscribe) {
                        tasksUnsubscribe();
                    }
                    listenToTasks();
                } else {
                    userId = null;
                    if (tasksUnsubscribe) {
                        tasksUnsubscribe();
                    }
                    allTasks = [];
                    renderAllTasks();
                    loadingOverlay.classList.remove('hidden');
                }
            });
        }

        function listenToTasks() {
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            const q = query(collectionRef, orderBy("createdAt", "desc"));

            tasksUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allTasks = [];
                querySnapshot.forEach((doc) => {
                    allTasks.push({ id: doc.id, ...doc.data() });
                });
                renderAllTasks();
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Lỗi lắng nghe dữ liệu:", error);
                loadingOverlay.innerHTML = '<p class="text-red-500 text-lg">Lỗi tải dữ liệu công việc.</p>';
            });
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loginBtn.addEventListener('click', handleAdminLogin);
            passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
            logoutBtn.addEventListener('click', handleAdminLogout);
            backupBtn.addEventListener('click', backupTasks);
            restoreBtn.addEventListener('click', () => restoreFileInput.click());
            restoreFileInput.addEventListener('change', handleFileRestore);

            taskList.addEventListener('click', handleTaskListClick);
            hideCompletedToggle.addEventListener('change', updateCompletedTasksVisibility);
            submitTaskBtn.addEventListener('click', handleSubmitTask);
            taskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmitTask(); }});
            
            hideCompletedToggle.checked = false;
            
            initializeFirebase();
        });
    </script>
</body>
</html>
