<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot với Gemini (Bảng quản trị API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #image-input, #admin-panel, #admin-login-panel { display: none; }
        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .key-status-active { background-color: #22c55e; } /* green-500 */
        .key-status-inactive { background-color: #6b7280; } /* gray-500 */
        .key-status-failed { background-color: #ef4444; } /* red-500 */
        .key-status-testing { background-color: #3b82f6; } /* blue-500 */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex flex-col items-center justify-center h-screen">

    <!-- Main Chat UI -->
    <div class="w-full max-w-2xl h-full md:h-[90vh] flex flex-col bg-white dark:bg-gray-800 shadow-2xl rounded-lg">
        <!-- Header -->
        <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between bg-blue-600 text-white rounded-t-lg">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                <h1 class="text-xl font-bold">Gemini Chatbot</h1>
            </div>
            <button id="open-admin-panel-btn" class="p-2 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto"></div>

        <!-- Input Area -->
        <div class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800 rounded-b-lg">
            <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
            <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
            <form id="chat-form" class="flex items-center gap-3">
                <input type="file" id="image-input" accept="image/*" multiple>
                <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </label>
                <input type="text" id="user-input" placeholder="Nhập tin nhắn hoặc tải ảnh lên..." class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" autocomplete="off">
                <button type="submit" id="send-button" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center">
                    <span id="send-text">Gửi</span>
                    <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login Panel Modal -->
    <div id="admin-login-panel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 m-4">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-600">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Đăng nhập Admin</h2>
                <button id="close-login-panel" class="text-2xl font-light p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 leading-none">&times;</button>
            </div>
            <form id="admin-login-form" class="mt-4 space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tên đăng nhập</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mật khẩu</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <p id="login-error-message" class="text-sm text-red-500 h-4"></p>
                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Đăng nhập</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 m-4">
            <div class="flex justify-between items-center border-b pb-3 dark:border-gray-600">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Bảng quản trị API Key</h2>
                <div>
                    <button id="logout-btn" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded mr-2">Đăng xuất</button>
                    <button id="close-admin-panel" class="text-2xl font-light p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 leading-none">&times;</button>
                </div>
            </div>
            <div class="mt-4">
                <form id="add-api-key-form" class="flex gap-2">
                    <input type="password" id="new-api-key-input" placeholder="Thêm API Key mới của Gemini" class="flex-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Thêm</button>
                </form>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Danh sách API Keys</h3>
                <p id="admin-status-message" class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-2 h-5"></p>
                <div id="api-key-list" class="mt-2 space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              chatContainer = document.getElementById('chat-container'), sendButton = document.getElementById('send-button'),
              sendText = document.getElementById('send-text'), loadingSpinner = document.getElementById('loading-spinner'),
              imageInput = document.getElementById('image-input'), imagePreviewContainer = document.getElementById('image-preview-container'),
              imageInfo = document.getElementById('image-info'), adminPanel = document.getElementById('admin-panel'),
              openAdminPanelBtn = document.getElementById('open-admin-panel-btn'), closeAdminPanelBtn = document.getElementById('close-admin-panel'),
              addApiKeyForm = document.getElementById('add-api-key-form'), newApiKeyInput = document.getElementById('new-api-key-input'),
              apiKeyListContainer = document.getElementById('api-key-list'), adminStatusMessage = document.getElementById('admin-status-message'),
              adminLoginPanel = document.getElementById('admin-login-panel'), adminLoginForm = document.getElementById('admin-login-form'),
              closeLoginPanelBtn = document.getElementById('close-login-panel'), loginErrorMessage = document.getElementById('login-error-message'),
              logoutBtn = document.getElementById('logout-btn');

        // State
        const MAX_IMAGES = 50;
        let chatHistory = [], uploadedImages = [], apiKeys = [];
        let currentApiKeyIndex = -1, isAdminLoggedIn = false;
        
        // Firebase State
        let db, auth, userId;
        const appId = 'data-chung-a62ee'; // Using projectId as a unique identifier for the app
        let unsubscribeFromApiKeys; // To store the onSnapshot listener

        // --- Core Functions ---
        const getGeminiResponse = async (retryCount = 0) => {
            if (currentApiKeyIndex === -1 || apiKeys.length === 0) throw new Error("Không có API key hợp lệ. Vui lòng thêm key trong bảng quản trị.");
            if (retryCount >= apiKeys.length) throw new Error("Tất cả API key đều không hoạt động. Vui lòng kiểm tra lại trong bảng quản trị.");
            const apiKeyData = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyData.key}`;
            const payload = { contents: chatHistory, generationConfig: { temperature: 0.7, topP: 1, topK: 1, maxOutputTokens: 2048 } };
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    if (response.status === 400 || response.status === 403 || (errorBody.error && errorBody.error.message.includes("API key not valid"))) throw new Error(`API Key không hợp lệ hoặc hết hạn (status ${response.status})`);
                    throw new Error(`Lỗi API: ${errorBody.error.message}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
                if (result.promptFeedback && result.promptFeedback.blockReason) return `Yêu cầu của bạn đã bị chặn vì: ${result.promptFeedback.blockReason}.`;
                throw new Error("Không nhận được phản hồi hợp lệ từ API.");
            } catch (error) {
                console.error(`API key tại vị trí ${currentApiKeyIndex} thất bại:`, error.message);
                updateApiKeyStatus(currentApiKeyIndex, 'failed');
                switchToNextApiKey();
                return getGeminiResponse(retryCount + 1);
            }
        };

        const switchToNextApiKey = () => {
            const totalKeys = apiKeys.length;
            if (totalKeys === 0) { currentApiKeyIndex = -1; updateAdminStatusMessage(); return; }
            for (let i = 1; i <= totalKeys; i++) {
                const nextIndex = (currentApiKeyIndex + i) % totalKeys;
                if (apiKeys[nextIndex] && apiKeys[nextIndex].status === 'inactive') {
                    currentApiKeyIndex = nextIndex;
                    updateApiKeyStatus(currentApiKeyIndex, 'active');
                    return;
                }
            }
            currentApiKeyIndex = -1;
            updateAdminStatusMessage();
        };

        // --- UI & Event Handlers ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message && uploadedImages.length === 0) return;
            if (apiKeys.length === 0) { appendMessage({ text: "Lỗi: Vui lòng thêm một API key trong bảng quản trị." }, 'bot', true); return; }
            if (currentApiKeyIndex === -1) { appendMessage({ text: "Lỗi: Tất cả API key đều không hoạt động." }, 'bot', true); return; }
            const userMessageData = { text: message, images: uploadedImages.map(img => img.file) };
            appendMessage(userMessageData, 'user');
            const userParts = [];
            if (message) userParts.push({ text: message });
            uploadedImages.forEach(img => userParts.push({ inlineData: { mimeType: img.mimeType, data: img.data } }));
            chatHistory.push({ role: "user", parts: userParts });
            userInput.value = ''; imagePreviewContainer.innerHTML = ''; uploadedImages = []; updateImageCount();
            toggleLoading(true);
            try {
                const botResponse = await getGeminiResponse();
                appendMessage({ text: botResponse }, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
            } catch (error) {
                console.error('Lỗi cuối cùng khi gửi tin nhắn:', error);
                appendMessage({ text: error.message }, 'bot', true);
            } finally {
                toggleLoading(false);
            }
        });
        
        // --- Admin & Login Panel Logic ---
        openAdminPanelBtn.addEventListener('click', () => {
            if (isAdminLoggedIn) adminPanel.style.display = 'flex';
            else adminLoginPanel.style.display = 'flex';
        });

        closeLoginPanelBtn.addEventListener('click', () => {
            adminLoginPanel.style.display = 'none';
            loginErrorMessage.textContent = '';
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            if (username === 'admin' && password === 'admin') {
                isAdminLoggedIn = true;
                adminLoginPanel.style.display = 'none';
                adminPanel.style.display = 'flex';
                e.target.reset();
                loginErrorMessage.textContent = '';
            } else {
                loginErrorMessage.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            isAdminLoggedIn = false;
            adminPanel.style.display = 'none';
        });

        closeAdminPanelBtn.addEventListener('click', () => adminPanel.style.display = 'none');
        
        addApiKeyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newKey = newApiKeyInput.value.trim();
            if (newKey && !apiKeys.some(k => k.key === newKey)) {
                const newApiKeys = [...apiKeys, { key: newKey, status: 'inactive' }];
                if (newApiKeys.filter(k => k.status === 'active').length === 0) {
                    const firstInactive = newApiKeys.findIndex(k => k.status === 'inactive');
                    if (firstInactive !== -1) newApiKeys[firstInactive].status = 'active';
                }
                apiKeys = newApiKeys;
                saveApiKeysToFirestore();
            }
            newApiKeyInput.value = '';
        });

        const renderApiKeys = () => {
            apiKeyListContainer.innerHTML = '';
            if (apiKeys.length === 0) { apiKeyListContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có API key nào.</p>'; return; }
            apiKeys.forEach((apiKey, index) => {
                const keyItem = document.createElement('div');
                keyItem.className = 'flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded';
                const statusColor = apiKey.status === 'active' ? 'key-status-active' : apiKey.status === 'failed' ? 'key-status-failed' : apiKey.status === 'testing' ? 'key-status-testing' : 'key-status-inactive';
                keyItem.innerHTML = `<div class="flex items-center gap-3"><span class="w-3 h-3 rounded-full ${statusColor}"></span><span class="font-mono text-sm text-gray-700 dark:text-gray-300">...${apiKey.key.slice(-6)}</span><span class="text-xs font-semibold capitalize text-gray-600 dark:text-gray-400">${apiKey.status}</span></div><div class="flex gap-2"><button data-index="${index}" class="test-key-btn bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">Kiểm tra</button><button data-index="${index}" class="remove-key-btn bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded">Xóa</button></div>`;
                apiKeyListContainer.appendChild(keyItem);
            });
            document.querySelectorAll('.remove-key-btn').forEach(btn => btn.addEventListener('click', handleRemoveKey));
            document.querySelectorAll('.test-key-btn').forEach(btn => btn.addEventListener('click', handleTestKey));
        };
        
        const handleRemoveKey = (e) => {
            const indexToRemove = parseInt(e.target.dataset.index);
            apiKeys.splice(indexToRemove, 1);
            if (indexToRemove === currentApiKeyIndex) {
                const newActiveIndex = apiKeys.findIndex(k => k.status !== 'failed');
                if (newActiveIndex !== -1) apiKeys[newActiveIndex].status = 'active';
            }
            saveApiKeysToFirestore();
        };

        const handleTestKey = async (e) => {
            const indexToTest = parseInt(e.target.dataset.index);
            const apiKeyData = apiKeys[indexToTest];
            const originalStatus = apiKeyData.status;
            updateApiKeyStatus(indexToTest, 'testing');
            try {
                const testUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKeyData.key}`;
                const response = await fetch(testUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: "hello" }] }] }) });
                if (!response.ok) throw new Error('Key không hợp lệ');
                updateApiKeyStatus(indexToTest, originalStatus === 'active' ? 'active' : 'inactive');
            } catch (error) {
                updateApiKeyStatus(indexToTest, 'failed');
            }
        };

        const updateApiKeyStatus = (index, status) => {
            if (apiKeys[index]) {
                apiKeys[index].status = status;
                if (status === 'active') {
                    apiKeys.forEach((key, i) => { if (i !== index && apiKeys[i].status === 'active') apiKeys[i].status = 'inactive'; });
                }
                saveApiKeysToFirestore();
            }
        };

        const updateAdminStatusMessage = () => {
            currentApiKeyIndex = apiKeys.findIndex(k => k.status === 'active');
            if (currentApiKeyIndex !== -1 && apiKeys[currentApiKeyIndex]) {
                adminStatusMessage.textContent = `Đang sử dụng API key ...${apiKeys[currentApiKeyIndex].key.slice(-6)}`;
                adminStatusMessage.className = 'text-sm text-green-600 dark:text-green-400 mt-1 mb-2 h-5';
            } else if (apiKeys.length > 0) {
                adminStatusMessage.textContent = 'Tất cả API key đều không hoạt động!';
                adminStatusMessage.className = 'text-sm text-red-600 dark:text-red-400 mt-1 mb-2 h-5';
            } else {
                adminStatusMessage.textContent = 'Vui lòng thêm một API key để bắt đầu.';
                adminStatusMessage.className = 'text-sm text-gray-600 dark:text-gray-400 mt-1 mb-2 h-5';
            }
        };

        // --- Firebase Persistence ---
        const saveApiKeysToFirestore = async () => {
            if (!db) return;
            try {
                const apiKeyDocRef = doc(db, `artifacts/${appId}/public/data/api_keys`, 'config');
                await setDoc(apiKeyDocRef, { keys: apiKeys });
            } catch (error) {
                console.error("Lỗi khi lưu API keys vào Firestore:", error);
                appendMessage({ text: "Lỗi: Không thể lưu cài đặt API." }, 'bot', true);
            }
        };

        const listenForApiKeyChanges = () => {
            if (!db) return;
            const apiKeyDocRef = doc(db, `artifacts/${appId}/public/data/api_keys`, 'config');
            if (unsubscribeFromApiKeys) unsubscribeFromApiKeys(); // Hủy đăng ký listener cũ
            
            unsubscribeFromApiKeys = onSnapshot(apiKeyDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    apiKeys = data.keys || [];
                    apiKeys.forEach(k => { if(k.status === 'testing') k.status = 'inactive' });
                } else {
                    apiKeys = [];
                }
                renderApiKeys();
                updateAdminStatusMessage();
            }, (error) => {
                console.error("Lỗi khi lắng nghe thay đổi API keys:", error);
                appendMessage({ text: "Lỗi: Không thể tải cấu hình API từ server." }, 'bot', true);
            });
        };
        
        // --- Initialization ---
        const initializeAppUI = () => {
            appendMessage({ text: "Xin chào! Hãy hỏi tôi bất cứ điều gì, hoặc gửi kèm hình ảnh để tôi phân tích." }, 'bot');
        };

        const main = async () => {
            try {
                // Hardcoded Firebase configuration provided by the user
                const firebaseConfig = {
                  apiKey: "AIzaSyDJBY6U0LUtmnk4PrfNeA7UE7qq1FZ84X8",
                  authDomain: "data-chung-a62ee.firebaseapp.com",
                  projectId: "data-chung-a62ee",
                  storageBucket: "data-chung-a62ee.appspot.com",
                  messagingSenderId: "453115303161",
                  appId: "1:453115303161:web:c885f876f4914829863e28",
                  measurementId: "G-QB6WP4SP09"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Đã xác thực với User ID:", userId);
                        listenForApiKeyChanges(); // Bắt đầu lắng nghe sau khi xác thực
                        initializeAppUI();
                    } else {
                        console.log("Người dùng chưa đăng nhập.");
                    }
                });

                // Sign in anonymously as there's no custom token in this context
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                appendMessage({ text: "Lỗi nghiêm trọng: Không thể kết nối đến dịch vụ backend. Vui lòng tải lại trang." }, 'bot', true);
            }
        };

        // --- Helper functions (unchanged) ---
        document.getElementById('image-upload-button').addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => { const files = e.target.files; if (!files) return; imageInfo.classList.remove('text-red-500'); if (uploadedImages.length + files.length > MAX_IMAGES) { imageInfo.textContent = `Bạn chỉ có thể tải lên tối đa ${MAX_IMAGES} ảnh.`; imageInfo.classList.add('text-red-500'); imageInput.value = ''; return; } for (const file of files) { const reader = new FileReader(); reader.onload = (event) => { const base64Data = event.target.result.split(',')[1]; uploadedImages.push({ data: base64Data, mimeType: file.type, file: file }); createImagePreview(event.target.result, file); updateImageCount(); }; reader.readAsDataURL(file); } imageInput.value = ''; });
        function createImagePreview(dataUrl, file) { const previewWrapper = document.createElement('div'); previewWrapper.className = 'relative'; const img = document.createElement('img'); img.src = dataUrl; img.className = 'h-16 w-16 object-cover rounded-md'; previewWrapper.appendChild(img); const removeBtn = document.createElement('button'); removeBtn.innerHTML = '&times;'; removeBtn.className = 'absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs'; removeBtn.onclick = () => { uploadedImages = uploadedImages.filter(img => img.file !== file); previewWrapper.remove(); updateImageCount(); }; previewWrapper.appendChild(removeBtn); imagePreviewContainer.appendChild(previewWrapper); }
        function updateImageCount() { imageInfo.classList.remove('text-red-500'); if (uploadedImages.length > 0) imageInfo.textContent = `Đã tải lên ${uploadedImages.length}/${MAX_IMAGES} ảnh.`; else imageInfo.textContent = ''; }
        function appendMessage(data, sender, isError = false) { const { text, images } = data; const messageWrapper = document.createElement('div'); messageWrapper.className = `flex items-start gap-3 mb-4 ${sender === 'user' ? 'justify-end' : ''}`; const messageContent = document.createElement('div'); messageContent.className = `p-3 rounded-lg max-w-xs md:max-w-md ${sender === 'user' ? 'bg-blue-600 text-white' : isError ? 'bg-red-100 dark:bg-red-900' : 'bg-gray-200 dark:bg-gray-700'}`; if (images && images.length > 0) { const imageGrid = document.createElement('div'); imageGrid.className = 'grid grid-cols-3 gap-1 mt-2'; images.forEach(file => { const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = 'w-full h-auto object-cover rounded'; img.onload = () => URL.revokeObjectURL(img.src); imageGrid.appendChild(img); }); messageContent.appendChild(imageGrid); } if(text) { const textElement = document.createElement('p'); textElement.className = `text-sm ${sender === 'bot' ? 'text-gray-800 dark:text-gray-200' : ''} ${(images && images.length > 0) ? ' mt-2' : ''}`; textElement.innerHTML = text.replace(/\n/g, '<br>'); messageContent.appendChild(textElement); } const avatar = document.createElement('div'); avatar.className = 'flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center font-bold'; if (sender === 'user') { avatar.className += ' bg-gray-300'; avatar.textContent = 'U'; messageWrapper.appendChild(messageContent); messageWrapper.appendChild(avatar); } else { avatar.className += ' bg-blue-500 text-white'; avatar.textContent = 'B'; messageWrapper.appendChild(avatar); messageWrapper.appendChild(messageContent); } chatContainer.appendChild(messageWrapper); chatContainer.scrollTop = chatContainer.scrollHeight; }
        function toggleLoading(isLoading) { sendButton.disabled = isLoading; userInput.disabled = isLoading; document.getElementById('image-upload-button').style.pointerEvents = isLoading ? 'none' : 'auto'; sendText.classList.toggle('hidden', isLoading); loadingSpinner.classList.toggle('hidden', !isLoading); if (!isLoading) userInput.focus(); }

        // Start the application
        main();
    </script>
</body>
</html>
